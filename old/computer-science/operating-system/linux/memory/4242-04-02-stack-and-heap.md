---
title: "stack and heap memory layout（栈和堆的内存布局）"
date: 2022-07-05 08:00:00 +0800
tags: computer-science operating-system linux memory
comment: false
show_author_profile: true
show_subscribe: false
---

#### 指针

注意：在 64 位的 cpu 架构下，不管指针指向的变量是什么类型，指针的大小始终是 8 byte。

变量 a 是一个 int 类型的变量，一级指针 p1a 指向 变量 a，二级指针 p2a 指向 一级指针 p1a。

```
> ./stack_pointer

  &a start address=0x7ffd9ae862e4
   a         value=16
&p1a start address=0x7ffd9ae862e8
 p1a         value=0x7ffd9ae862e4
&p2a start address=0x7ffd9ae862f0
 p2a         value=0x7ffd9ae862e8
```

p1a 存储的是 a 的起始地址，p2a 存储的是 p1a 的起始地址。

```
(gdb) p &a
$1 = (int *) 0x7fffffffde44
(gdb) p &p1a
$2 = (int **) 0x7fffffffde48
(gdb) p &p2a
$3 = (int ***) 0x7fffffffde50
```

- p1a 的内存单元上存储的数据是小端字节序形式的 a 的起始地址。0x 44 de ff ff ff 7f 00 00 => 0x 00 00 7f ff ff ff de 44
- p2a 的内存单元上存储的数据是小端字节序形式的 p1a 的起始地址。0x 48 de ff ff ff 7f 00 00 => 0x 00 00 7f ff ff ff de 48

```
(gdb) x/4xb &a
0x7fffffffde44:	0x10	0x00	0x00	0x00
(gdb) x/8xb &p1a
0x7fffffffde48:	0x44	0xde	0xff	0xff	0xff	0x7f	0x00	0x00
(gdb) x/8xb &p2a
0x7fffffffde50:	0x48	0xde	0xff	0xff	0xff	0x7f	0x00	0x00
```

### 堆

#### 一级指针

p1arr1 是一个指向一维数组的指针。声明 p1arr1 后，动态分配一维数组的内存空间并存入数据。

```
> ./heap_pointer1

&p1arr1   value=0x7fffffffde50
p1arr1    value=0x5555555592a0
*p1arr1   value=16
*p1arr1+1 value=256
*p1arr1+2 value=4096
```

p1arr1 是局部变量，p1arr1 的地址在栈区。p1arr1 上存储的是动态分配出来的一维数组的内存空间的地址，这块内存空间在堆区。

```
      0x555555559000     0x55555557a000    0x21000        0x0  rw-p   [heap]
      0x7ffffffde000     0x7ffffffff000    0x21000        0x0  rw-p   [stack]
```

可以和进程内存信息比对一下。

```
0x555555559290:	0x00	0x00	0x00	0x00	0x00	0x00	0x00	0x00
0x555555559298:	0x21	0x00	0x00	0x00	0x00	0x00	0x00	0x00
0x5555555592a0:	0x00	0x00	0x00	0x00	0x00	0x00	0x00	0x00
0x5555555592a8:	0x00	0x00	0x00	0x00	0x00	0x00	0x00	0x00
0x5555555592b0:	0x00	0x00	0x00	0x00	0x00	0x00	0x00	0x00
0x5555555592b8:	0x51	0x0d	0x02	0x00	0x00	0x00	0x00	0x00
```

这是没有赋值前，p1arr1 指向的内存空间及其前后几个内存单元上的数据。

```
(gdb) x/48xb p1arr1-4
0x555555559290:	0x00	0x00	0x00	0x00	0x00	0x00	0x00	0x00
0x555555559298:	0x21	0x00	0x00	0x00	0x00	0x00	0x00	0x00
0x5555555592a0:	0x10	0x00	0x00	0x00	0x00	0x01	0x00	0x00
0x5555555592a8:	0x00	0x10	0x00	0x00	0x00	0x00	0x00	0x00
0x5555555592b0:	0x00	0x00	0x00	0x00	0x00	0x00	0x00	0x00
0x5555555592b8:	0x11	0x04	0x00	0x00	0x00	0x00	0x00	0x00
```

这是没有释放前，p1arr1 指向的内存空间及其前后几个内存单元上的数据。其中，从 0x5555555592a0 开始的 12 个 byte 存储了数据。

```
x/48xb p1arr1-4
0x555555559290:	0x00	0x00	0x00	0x00	0x00	0x00	0x00	0x00
0x555555559298:	0x21	0x00	0x00	0x00	0x00	0x00	0x00	0x00
0x5555555592a0:	0x59	0x55	0x55	0x55	0x05	0x00	0x00	0x00
0x5555555592a8:	0xe2	0x24	0x38	0x0d	0x3c	0xe0	0xe0	0xa9
0x5555555592b0:	0x00	0x00	0x00	0x00	0x00	0x00	0x00	0x00
0x5555555592b8:	0x11	0x04	0x00	0x00	0x00	0x00	0x00	0x00
```

这是释放之后，p1arr1 指向的内存空间及其前后几个内存单元上的数据。可以看到，从 0x5555555592a0 开始的 12 个 byte 上的数据发生了变化。

#### 多级指针

p1 是一个 int 类型的二级指针。声明 p1 后，动态分配一级指针的内存空间。然后给这个一级指针，再动态分配一个 int 类型的内存空间并存入数据。

```
(gdb) p &p1
$1 = (int ***) 0x7fffffffde40
(gdb) p &(*p1)
$2 = (int **) 0x5555555592a0
(gdb) p &(**p1)
$3 = (int *) 0x5555555596d0
```

p1 是局部变量，p1 的地址在栈区。p1 上存储的是动态分配出来的一级指针的内存空间的地址，这块内存空间在堆区。

然后又动态申请了一块 int 类型的内存空间，这块内存空间在堆区，然后 malloc 函数返回的这块内存空间的地址存储在刚才的一级指针的内存空间里。

```
(gdb) x /8xb &p1
0x7fffffffde40:	0xa0	0x92	0x55	0x55	0x55	0x55	0x00	0x00
(gdb) x /8xb &*p1
0x5555555592a0:	0xd0	0x96	0x55	0x55	0x55	0x55	0x00	0x00
(gdb) x /4xb &**p1
0x5555555596d0:	0x10	0x00	0x00	0x00
```

| 变量 p1 的内存地址 | 数据 | 变量 \*p1 的内存地址 | 数据 | 变量 \*\*p1 的内存地址 | 数据 |
| --- | --- | --- | --- | --- | --- |
| 0x7fffffffde40 | 0xa0 | 0x5555555592a0 | 0xd0 | 0x5555555596d0 | 0x10 |
| 0x7fffffffde41 | 0x92 | 0x5555555592a1 | 0x96 | 0x5555555596d1 | 0x00 |
| 0x7fffffffde42 | 0x55 | 0x5555555592a2 | 0x55 | 0x5555555596d2 | 0x00 |
| 0x7fffffffde43 | 0x55 | 0x5555555592a3 | 0x55 | 0x5555555596d3 | 0x00 |
| 0x7fffffffde44 | 0x55 | 0x5555555592a4 | 0x55 | - | - |
| 0x7fffffffde45 | 0x55 | 0x5555555592a5 | 0x55 | - | - |
| 0x7fffffffde46 | 0x00 | 0x5555555592a6 | 0x00 | - | - |
| 0x7fffffffde47 | 0x00 | 0x5555555592a7 | 0x00 | - | - |

### reference（参考）

- 北风之神（微信：Le-studyg）
  - 高级课程
