## 资料

代码：{demo-c}/demo-in-linux/process/
### 进程的回收

笔记主要涉及：wait()、waitpid()

#### wait()、waitpid()

这两个系统调用的声明如下。

> pid_t wait(int *wstatus);</br>
> pid_t waitpid(pid_t pid, int *wstatus, int options);

> DESCRIPTION</br>
> All of these system calls are used to wait for state changes in a child of the calling process,
> and obtain information about the child whose state has changed.</br>
> A state change is considered to be: the child terminated; the child was stopped by a signal;
> or the child was resumed by a signal.</br>
> </br>
> If a child has already changed state, then these calls return immediately.</br>
> Otherwise, they block until either a child changes state or a signal handler interrupts the call
> (assuming that system calls are not automatically restarted using the SA_RESTART flag of sigaction(2)).</br>
> ...

> RETURN VALUE</br>
> wait(): on success, returns the process ID of the terminated child; on failure, -1 is returned.</br>
> waitpid(): on success, returns the process ID of the child whose state has changed;
> if WNOHANG was specified and one or more child(ren) specified by pid exist,
> but have not yet changed state, then 0 is returned. On failure, -1 is returned.

wait() 用于等待调用进程的一个子进程的状态变化，并获取状态发生变化的子进程的信息。
比如，子进程终止；子进程被信号停止；子进程被信号恢复。如果一个子进程已经改变了状态，那么调用进程调用 wait() 会立即返回。
否则，调用进程就会阻塞，直到子进程改变状态或信号处理程序中断调用。

> DESCRIPTION</br>
> The wait() system call suspends execution of the calling thread until one of its children terminates.</br>
> The call `wait(&wstatus)` is equivalent to: `waitpid(-1, &wstatus, 0)`</br>
> ...</br>

`wait(&status)` 和 `waitpid(-1, &status, 0)` 是等效的。

> DESCRIPTION</br>
> If wstatus is not NULL, wait() and waitpid() store status information in the int to which it points.</br>
> This integer can be inspected with the following macros
> (which take the integer itself as an argument, not a pointer to it, as is done in wait() and waitpid()!):</br>
> ...

wait()、waitpid() 调用成功的时候，返回值是子进程的 pid，传进去的参数 wstatus 会记录子进程的退出信息。
退出信息可以用提供的宏函数确定是哪一种。

代码示例：{demo-c}/demo-in-linux/process/wait.c

#### 宏函数

> WIFEXITED(wstatus)</br>
> returns true if the child terminated normally, that is, by calling exit(3) or _exit(2),
> or by returning from main().</br>

如果子进程是正常退出的 `WIFEXITED(wstatus)` 会返回一个非零值。

> WEXITSTATUS(wstatus)</br>
> returns the exit status of the child.</br>
> This consists of the least significant 8 bits of the status argument
> that the child specified in a call to exit(3) or _exit(2)
> or as the argument for a return statement in main().</br>
> This macro should be employed only if WIFEXITED returned true.

当 WIFEXITED() 返回非零值时，可以用 WEXITSTATUS() 来提取子进程的返回值。
如果子进程调用 `exit(5)` 退出，`WEXITSTATUS(status)` 就会返回 5。

代码示例：{demo-c}/demo-in-linux/process/waitpid_macros.c
