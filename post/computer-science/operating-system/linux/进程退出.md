
### 进程的退出

笔记主要涉及：exit()、_exit()、_Exit()、exit_group()、abort()。

代码示例：{demo-c}/demo-in-linux/process/exit.c

#### 进程退出的方式

- 程序运行到最后一行代码。
- 主动调用 exit()、_exit()、_Exit()、exit_group()
- 主动 `return 0`。
- 主动调用 abort()，会导致进程异常终止，报 "Aborted (core dumped)" 错误。
- 进程收到了中断信号。

#### exit()

> DESCRIPTION</br>
> The exit() function causes normal process termination and the least significant byte of
> status (i.e., status & 0xFF) is returned to the parent (see wait(2)).</br>
> All functions registered with atexit(3) and on_exit(3) are called,
> in the reverse order of their registration.</br>
> ...</br>
> If one of these functions does not return (e.g., it calls _exit(2), or kills itself with a signal),
> then none of the remaining functions is called, and further exit processing
> (in particular, flushing of stdio(3) streams) is abandoned.</br>
> All open stdio(3) streams are flushed and closed.</br>
> Files created by tmpfile(3) are removed.</br>
> ...

exit() 会让进程正常终止，退出状态码会先和 0xFF 做与运算，然后返回给父进程。所有打开的 stdio(3) 流会被刷新然后关闭

#### _exit()、_Exit()

> DESCRIPTION</br>
> _exit() terminates the calling process "immediately".</br>
> Any open file descriptors belonging to the process are closed.</br>
> Any children of the process are inherited by init(1)
> (or by the nearest "subreaper" process as defined through the use of
> the prctl(2) PR_SET_CHILD_SUBREAPER operation).</br>
> The process's parent is sent a SIGCHLD signal.</br>
> The value status & 0xFF is returned to the parent process as the process's exit status,
> and can be collected by the parent using one of the wait(2) family of calls.</br>
> The function _Exit() is equivalent to _exit().

> NOTES</br>
> ...</br>
> The function _exit() is like exit(3), but does not call any
> functions registered with atexit(3) or on_exit(3).</br>
> Open stdio(3) streams are not flushed.</br>
> ...

_exit() （_Exit()和 _exit() 是等价的）会让进程立即终止，
子进程退出时会向父进程发送 SIGCHLD 中断信号，退出状态码会先和 0xFF 做与运算，然后返回给父进程。
打开的 stdio(3) 流不会被刷新。

#### exit_group()

> SYNOPSIS         
> Note: glibc provides no wrapper for exit_group(), necessitating the use of syscall(2).

> DESCRIPTION
> This system call is equivalent to _exit(2) except that it terminates
> not only the calling thread, but all threads in the calling process's thread group.

#### 退出状态码

```
[00007fdf9e51ea3d] exit_group(0)        = ?
[????????????????] +++ exited with 0 +++
```

退出状态码会先和 0xFF 做与运算。这个的意思是说，加入退出状态码设置的是 300，那实际返回的是 300 & 255 的结果，也就是 44。

```
[00007fb290aeaca1] exit_group(300)      = ?
[????????????????] +++ exited with 44 +++
```

在终端里使用 `echo $?` 命令，可以打印上一个程序的退出状态码。

#### 不同退出方式下 printf() 的区别

上面提到，过不同的退出方式，对打开的 stdio(3) 流的处理方式不一样。

程序运行到最后一行代码、主动 `return 0`、主动调用 exit() 时，会检查文件的打开情况，处理 I/O 缓冲区内的内容。
而主动调用 _exit()、_Exit()、exit_group 时不会。

也就是对于 `printf("hello, world")` （注意，没有 \n）来说，前面三个方式会输出 hello, world，而前面三个方式不会输出。
