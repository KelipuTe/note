<!doctype html><html lang=zh-cn data-theme=light><head><meta charset=utf-8><meta name=viewport content="width=device-width"><meta name=theme-color content="#222" media="(prefers-color-scheme: light)"><meta name=generator content="Hugo 0.103.1"><link rel="shortcut icon" type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/png sizes=16x16 href=/imgs/icons/favicon_16x16_next.png><link rel=icon type=image/png sizes=32x32 href=/imgs/icons/favicon_32_32_next.png><link rel=apple-touch-icon sizes=180x180 href=/imgs/icons/apple_touch_icon_next.png><meta itemprop=name content="【过期，留做对比】Golang 实现复杂的 Web 框架"><meta itemprop=description content><meta itemprop=datePublished zgotmplz><meta itemprop=dateModified zgotmplz><meta itemprop=image content="/image/pid49256268.jpg"><meta itemprop=keywords content="computer-science(计算机科学),programming-language(编程语言),framework(框架),web,http,router(路由),middleware(中间件),golang"><meta property="og:type" content="article"><meta property="og:title" content="【过期，留做对比】Golang 实现复杂的 Web 框架"><meta property="og:description" content><meta property="og:image" content="/image/pid49256268.jpg"><meta property="og:image:width" content="312"><meta property="og:image:height" content="312"><meta property="og:image:type" content="image/jpeg/png/svg/jpg"><meta property="og:url" content="/post/computer-science/programming-language/framework/web/golang/complex/"><meta property="og:site_name" content="帕里特档案馆"><meta property="og:locale" content="zh-CN"><meta property="article:author" content="西柊慧音"><meta property="article:published_time" content="2022-09-24 08:00:00 +0800 CST"><meta property="article:modified_time" content="2022-09-25 08:00:00 +0800 CST"><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/font-awesome/6.1.2/css/all.min.css><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/animate.css/3.1.1/animate.min.css><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/viewerjs/1.11.0/viewer.min.css><link rel=stylesheet href=/css/main.min.4da9279b6033ade10d67092d7bfb660265f9fa46c40974f17b13bfe235396546.css><style type=text/css>.post-footer,.flinks-list-footer hr:after{content:"~ 我可是有底线的哟 ~"}</style><script type=text/javascript>(function(){localDB={set:function(e,t,n){if(n===0)return;const s=new Date,o=n*864e5,i={value:t,expiry:s.getTime()+o};localStorage.setItem(e,JSON.stringify(i))},get:function(e){const t=localStorage.getItem(e);if(!t)return void 0;const n=JSON.parse(t),s=new Date;return s.getTime()>n.expiry?(localStorage.removeItem(e),void 0):n.value}},theme={active:function(){const e=localDB.get("theme");if(e==null)return;theme.toggle(e),window.matchMedia("(prefers-color-scheme: dark)").addListener(function(e){theme.toggle(e.matches?"dark":"light")})},toggle:function(e){document.documentElement.setAttribute("data-theme",e),localDB.set("theme",e,2);const t=document.querySelector("iframe.giscus-frame");if(t){const n={setConfig:{theme:e}};t.contentWindow.postMessage({giscus:n},"https://giscus.app")}}},theme.active()})(window)</script><script class=next-config data-name=page type=application/json>{"comments":false,"isHome":false,"isPage":true,"path":"complex","permalink":"/post/computer-science/programming-language/framework/web/golang/complex/","title":"【过期，留做对比】Golang 实现复杂的 Web 框架","waline":{"js":[{"alias":"waline","alias_name":"@waline/client","file":"dist/pageview.js","name":"pageview","version":"2.13.0"},{"alias":"waline","alias_name":"@waline/client","file":"dist/comment.js","name":"comment","version":"2.13.0"}]}}</script><script type=text/javascript>document.addEventListener("DOMContentLoaded",()=>{var e=document.createElement("script");e.charset="UTF-8",e.src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js",e.async=!1,e.defer=!0,document.head.appendChild(e),e.onload=function(){NexT.utils.fmtBusuanzi()}})</script><title>【过期，留做对比】Golang 实现复杂的 Web 框架 - 帕里特档案馆</title><noscript><link rel=stylesheet href=/css/noscript.css></noscript></head><body itemscope itemtype=http://schema.org/WebPage class=use-motion><div class=headband></div><main class=main><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div class=toggle aria-label=切换导航栏 role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div></div><div class=site-meta><a href=/ class=brand rel=start><i class=logo-line></i><h1 class=site-title>帕里特档案馆</h1><i class=logo-line></i></a><p class=site-subtitle itemprop=description>重建中</p></div><div class=site-nav-right><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class=site-nav><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href=/ class=hvr-icon-pulse rel=section><i class="fa fa-home hvr-icon"></i>首页</a></li><li class="menu-item menu-item-about"><a href=/about/ class=hvr-icon-pulse rel=section><i class="fa fa-user hvr-icon"></i>关于</a></li><li class="menu-item menu-item-archives"><a href=/archives/ class=hvr-icon-pulse rel=section><i class="fa fa-archive hvr-icon"></i>归档
<span class=badge>48</span></a></li><li class="menu-item menu-item-commonweal"><a href=/404.html class=hvr-icon-pulse rel=section><i class="fa fa-heartbeat hvr-icon"></i>公益 404</a></li><li class="menu-item menu-item-search"><a role=button class="popup-trigger hvr-icon-pulse"><i class="fa fa-search fa-fw hvr-icon"></i>搜索</a></li></ul></nav><div class=search-pop-overlay><div class="popup search-popup"><div class=search-header><span class=search-icon><i class="fa fa-search"></i></span><div class=search-input-container><input autocomplete=off autocapitalize=off maxlength=80 placeholder=搜索... spellcheck=false type=search class=search-input></div><span class=popup-btn-close role=button><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class=search-result-icon><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></div><div class="toggle sidebar-toggle" role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div><aside class=sidebar><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class=sidebar-nav><li class=sidebar-nav-toc>文章目录</li><li class=sidebar-nav-overview>站点概览</li></ul><div class=sidebar-panel-container><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><nav id=TableOfContents><ul><li><ul><li><a href=#前言>前言</a></li><li><a href=#资料>资料</a></li><li><a href=#实现功能>实现功能</a></li><li><a href=#路由树>路由树</a></li><li><a href=#路由组>路由组</a></li><li><a href=#中间件>中间件</a></li><li><a href=#优雅退出>优雅退出</a></li></ul></li></ul></nav></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image alt=西柊慧音 src=/imgs/img-lazy-loading.gif data-src=/image/pid49256268.jpg><p class=site-author-name itemprop=name>西柊慧音</p><div class=site-description itemprop=description></div></div><div class="site-state-wrap site-overview-item animated"><nav class=site-state><div class="site-state-item site-state-posts"><a href=/archives/><span class=site-state-item-count>48</span>
<span class=site-state-item-name>日志</span></a></div><div class="site-state-item site-state-categories"><a href=/categories/><span class=site-state-item-count>10</span>
<span class=site-state-item-name>分类</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/><span class=site-state-item-count>43</span>
<span class=site-state-item-name>标签</span></a></div></nav></div><div class="links-of-social site-overview-item animated"><span class=links-of-social-item><a href=https://github.com/KelipuTe title="Github → https://github.com/KelipuTe" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-github fa-fw hvr-icon"></i>Github</a></span>
<span class=links-of-social-item><a href=xhy_1365@sina.com title="E-Mail → xhy_1365@sina.com" rel=noopener class=hvr-icon-pulse target=_blank><i class="fa fa-envelope fa-fw hvr-icon"></i>E-Mail</a></span></div><div class="cc-license animated" itemprop=license><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh class=cc-opacity rel=noopener target=_blank title=共享知识><img src=/imgs/img-lazy-loading.gif data-src=/imgs/cc/big/by_nc_sa.svg alt=共享知识></a></div><div class="links-of-blogroll site-overview-item animated"><div class=links-of-blogroll-title><i class="fa fa-globe fa-fw"></i>友情链接</div><ul class=links-of-blogroll-list><li class=links-of-blogroll-item><a href=https://gitee.com/hugo-next/hugo-theme-next title=https://gitee.com/hugo-next/hugo-theme-next target=_blank>Hugo-NexT</a></li><li class=links-of-blogroll-item><a href=https://lisenhui.cn title=https://lisenhui.cn target=_blank>凡梦星尘空间站</a></li></ul></div></div></div></div></aside><div class=sidebar-dimmer></div></header><div class=tool-buttons><div id=toggle-theme class=button title=深浅模式切换><i class="fas fa-adjust"></i></div><div class=back-to-top role=button title=返回顶部><i class="fa fa-arrow-up"></i>
<span>0%</span></div></div><div class=reading-progress-bar></div><a role=button class="book-mark-link book-mark-link-fixed"></a>
<a href=https://github.com/hugo-next rel="noopener external nofollow noreferrer" target=_blank title="Follow me on GitHub" class="exturl github-corner"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentcolor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentcolor" class="octo-body"/></svg></a><noscript><div class=noscript-warning>Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class=post-block><article itemscope itemtype=http://schema.org/Article class=post-content lang><link itemprop=mainEntityOfPage href=/post/computer-science/programming-language/framework/web/golang/complex/><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content="/image/pid49256268.jpg"><meta itemprop=name content="西柊慧音"></span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="西柊慧音"><meta itemprop=description content></span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork><meta itemprop=name content="【过期，留做对比】Golang 实现复杂的 Web 框架"><meta itemprop=description content="使用 net/http 包，实现一个复杂的 Web 框架。"></span><header class=post-header><h1 class=post-title itemprop="name headline">【过期，留做对比】Golang 实现复杂的 Web 框架</h1><div class=post-meta-container><div class=post-meta-items><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar"></i></span>
<span class=post-meta-item-text>发表于：</span>
<time title="发表于：2022-09-24 08:00:00 +0800 CST" itemprop="dateCreated datePublished" datetime="2022-09-24 08:00:00 +0800 CST">2022-09-24</time></span>
<span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar-check"></i></span>
<span class=post-meta-item-text>更新于：</span>
<time title=修改时间：2022-09-25T08:00:00+08:00 itemprop=dateModified datetime=2022-09-25T08:00:00+08:00>2022-09-25</time></span>
<span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-folder-open"></i></span>
<span class=post-meta-item-text>分类于：</span>
<span itemprop=about itemscope itemtype=http://schema.org/Thing><a href=/categories/framework%E6%A1%86%E6%9E%B6 itemprop=url rel=index><span itemprop=name>framework(框架)</span></a></span></span></div><div class=post-meta-items><span class=post-meta-item title=字数><span class=post-meta-item-icon><i class="far fa-file-word"></i></span>
<span class=post-meta-item-text>字数：</span><span>2534</span></span>
<span class=post-meta-item title=阅读><span class=post-meta-item-icon><i class="far fa-clock"></i></span>
<span class=post-meta-item-text>阅读：&ap;</span>
<span>6分钟</span></span>
<span class=post-meta-item title=浏览><span class=post-meta-item-icon><i class="far fa-eye"></i></span>
<span class=post-meta-item-text>浏览：</span>
<span id=busuanzi_value_page_pv data-path=/post/computer-science/programming-language/framework/web/golang/complex/><i class="fa fa-sync fa-spin"></i></span></span></div></div></header><div class="post-body autonumber" itemprop=articleBody><blockquote><p>CPU AMD64(x86_64)<br>Windows 11 家庭版<br>go version go1.19 windows/amd64</p></blockquote><h3 id=前言>前言</h3><p>在看这篇之前，建议先看下面这几篇：</p><ul><li><a href=/post/computer-science/programming-language/golang/http title="Golang 开启 HTTP 服务">Golang 开启 HTTP 服务</a></li><li><a href=/post/computer-science/programming-language/framework/web/golang/router title="Golang 实现简单的 Web 框架 &amp;ndash; router(路由)">Golang 实现简单的 Web 框架 &ndash; router(路由)</a></li><li><a href=/post/computer-science/programming-language/framework/web/golang/middleware title="Golang 实现简单的 Web 框架 &amp;ndash; middleware(中间件)">Golang 实现简单的 Web 框架 &ndash; middleware(中间件)</a></li></ul><p>路由树是 web 框架的核心。其他的功能，都是在路由树的基础上，再增加亿点点细节而已。</p><h3 id=资料>资料</h3><ul><li>{web-framework-go}/v40</li></ul><h3 id=实现功能>实现功能</h3><ul><li>主要实现：<ul><li>路由树（静态、通配符、路径参数、正则表达式）、路由组</li><li>全局中间件、可路由的中间件</li></ul></li><li>次要实现：<ul><li>内存池（请求上下文对象复用）</li><li>服务管理（管理多个子服务）</li><li>优雅退出、退出时的回调方法</li></ul></li><li>计划实现：<ul><li>用户认证（中间件实现）</li><li>文件操作（上传、下载）</li><li>单元测试、集成测试、性能测试</li><li>设计文档</li></ul></li></ul><h3 id=路由树>路由树</h3><p>首先是路由树结点的设计。结点的基础数据包括：结点类型、这个路由结点代表的那段路径、命中路由之后的的处理逻辑。</p><p>静态路由子结点使用 map 结构存储，查询时直接就可以通过路由段查询子结点。</p><p>通配符子结点、路径参数子结点、正则表达式子结点，这三个结点属于特殊结点，而且存在冲突关系，所以单独存储。</p><p>为了支持可路由的中间件，路由结点上还需要有存储中间件的地方，这样就可以为每个结点单独设置中间件。</p><p>另外，服务在运行的时候只要命中的是同一个路由，那么用到的中间件一定也是相同的，在服务启动的时候就可以把中间件遍历好，然后缓存下来。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// routingNode 路由结点
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>routingNode</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// nodeType 结点类型
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>nodeType</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// part 这个路由结点代表的那段路径
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>part</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// path 从根路由到这个路由结点的全路径
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>path</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// f4handler 命中路由之后的处理逻辑
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>f4handler</span> <span style=color:#a6e22e>HTTPHandleFunc</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// m3routingTree 路由子树，子结点的 path =&gt; 子树根结点
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>m3routingTree</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#f92672>*</span><span style=color:#a6e22e>routingNode</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// p7paramChild 路径参数结点
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>p7paramChild</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>routingNode</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// paramName 路径参数路由和正则表达式路由，都会提取路由参数的名字
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>paramName</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// p7regexpChild 正则表达式结点
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>p7regexpChild</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>routingNode</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// p7regexp 正则表达式
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>p7regexp</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>regexp</span>.<span style=color:#a6e22e>Regexp</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// p7anyChild 通配符结点
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>p7anyChild</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>routingNode</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// s5f4middleware 结点上注册的中间件
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>s5f4middleware</span> []<span style=color:#a6e22e>HTTPMiddleware</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// s5f4middlewareCache 服务启动后，命中结点时，需要用到的所有中间件
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>s5f4middlewareCache</span> []<span style=color:#a6e22e>HTTPMiddleware</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>路由树的构造和遍历并不复杂，使用递归逻辑处理即可。不用担心递归带来的性能问题。</p><p>对于路由树的递归操作，都发生在服务启动时，这个时候会遍历路由树然后将结果缓存下来。</p><p>服务启动后，当请求访问过来时，就可以直接使用缓存里的结果，而不用每次都去遍历路由树。</p><h3 id=路由组>路由组</h3><p>路由组就是个语法糖。相当于路由组方法会在路由组内的每个成员注册的时候，附加路由组的路由前缀和路由组定义的中间件。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// Group 添加一组路由
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>p7this</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>HTTPHandler</span>) <span style=color:#a6e22e>Group</span>(<span style=color:#a6e22e>path</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>s5f4mw</span> []<span style=color:#a6e22e>HTTPMiddleware</span>, <span style=color:#a6e22e>s5routeData</span> []<span style=color:#a6e22e>RouteData</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>rd</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>s5routeData</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>t4path</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>path</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#e6db74>&#34;/&#34;</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>rd</span>.<span style=color:#a6e22e>Path</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>t4path</span> = <span style=color:#a6e22e>path</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>rd</span>.<span style=color:#a6e22e>Path</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>p7this</span>.<span style=color:#a6e22e>addRoute</span>(<span style=color:#a6e22e>rd</span>.<span style=color:#a6e22e>Method</span>, <span style=color:#a6e22e>t4path</span>, <span style=color:#a6e22e>rd</span>.<span style=color:#a6e22e>F4handle</span>, <span style=color:#a6e22e>s5f4mw</span><span style=color:#f92672>...</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=中间件>中间件</h3><p>全局中间件和可路由中间件是分开放的。全局中间件存储在核心处理逻辑上。可路由中间件存储在路由树结点上。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// HTTPHandlerInterface 核心处理逻辑的接口定义
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>HTTPHandlerInterface</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Handler</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// HTTPHandler 核心处理逻辑
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>HTTPHandler</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// s5f4middleware 全局中间件
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>s5f4middleware</span> []<span style=color:#a6e22e>HTTPMiddleware</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>当请求访问过来时，第一站到的是核心处理逻辑，核心处理逻辑会完成全局中间件的组装和执行。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>p7this</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>HTTPHandler</span>) <span style=color:#a6e22e>ServeHTTP</span>(<span style=color:#a6e22e>i9w</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ResponseWriter</span>, <span style=color:#a6e22e>p7r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>) {
</span></span><span style=display:flex><span>	<span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 倒过来组装，先组装的在里层，里层的后执行
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// 最里层应该是找路由然后执行业务代码
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>t4chain</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>p7this</span>.<span style=color:#a6e22e>doServeHTTP</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> len(<span style=color:#a6e22e>p7this</span>.<span style=color:#a6e22e>s5f4middleware</span>) <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>; <span style=color:#a6e22e>i</span> <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>--</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>t4chain</span> = <span style=color:#a6e22e>p7this</span>.<span style=color:#a6e22e>s5f4middleware</span>[<span style=color:#a6e22e>i</span>](<span style=color:#a6e22e>t4chain</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 写入响应数据这个中间件应该由框架开发者处理
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// 它是最后一个环节，应该在最外层
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>t4m</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>FlashRespMiddleware</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>t4chain</span> = <span style=color:#a6e22e>t4m</span>(<span style=color:#a6e22e>t4chain</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>t4chain</span>(<span style=color:#a6e22e>p7ctx</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>在通过全局中间件之后，进入查询路由树的步骤。查询结果里会有路由树结点上的可路由中间件。</p><p>使用和全局中间件一样的套路，完成一遍可路由中间件的组装和执行。最后调用路由上的处理逻辑，开始真正的业务逻辑。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>p7this</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>HTTPHandler</span>) <span style=color:#a6e22e>doServeHTTP</span>(<span style=color:#a6e22e>p7ctx</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>HTTPContext</span>) {
</span></span><span style=display:flex><span>	<span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>p7ri</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>p7this</span>.<span style=color:#a6e22e>findRoute</span>(<span style=color:#a6e22e>p7ctx</span>.<span style=color:#a6e22e>P7request</span>.<span style=color:#a6e22e>Method</span>, <span style=color:#a6e22e>p7ctx</span>.<span style=color:#a6e22e>P7request</span>.<span style=color:#a6e22e>URL</span>.<span style=color:#a6e22e>Path</span>)
</span></span><span style=display:flex><span>	<span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 这里用同样的套路，处理路由上的中间件，最后执行业务代码
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>t4chain</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>p7ri</span>.<span style=color:#a6e22e>p7node</span>.<span style=color:#a6e22e>f4handler</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> len(<span style=color:#a6e22e>p7ri</span>.<span style=color:#a6e22e>p7node</span>.<span style=color:#a6e22e>s5f4middlewareCache</span>) <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>; <span style=color:#a6e22e>i</span> <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>--</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>t4chain</span> = <span style=color:#a6e22e>p7ri</span>.<span style=color:#a6e22e>p7node</span>.<span style=color:#a6e22e>s5f4middlewareCache</span>[<span style=color:#a6e22e>i</span>](<span style=color:#a6e22e>t4chain</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>t4chain</span>(<span style=color:#a6e22e>p7ctx</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=优雅退出>优雅退出</h3><p>想实现优雅退出，程序就不能阻塞在不可控的位置。这里可以直接把服务丢到协程里去。</p><p>然后在最外面，实现一个信号等待的逻辑，这样就可以通过信号控制程序的运行状态。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>p7this</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ServiceManager</span>) <span style=color:#a6e22e>Start</span>() {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 启动服务
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;服务启动中。。。&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>p7s</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>p7this</span>.<span style=color:#a6e22e>s5p7HTTPService</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>t4p7s</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>p7s</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>t4p7s</span>.<span style=color:#a6e22e>Start</span>(); <span style=color:#66d9ef>nil</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>err</span> {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ErrServerClosed</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>err</span> {
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;子服务 %s 已关闭\n&#34;</span>, <span style=color:#a6e22e>t4p7s</span>.<span style=color:#a6e22e>name</span>)
</span></span><span style=display:flex><span>				} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;子服务 %s 异常退出，err:%s\r\n&#34;</span>, <span style=color:#a6e22e>t4p7s</span>.<span style=color:#a6e22e>name</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}()
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;服务启动完成。&#34;</span>)
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 监听 ctrl+c 信号
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>c4signal</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>chan</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Signal</span>, <span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>signal</span>.<span style=color:#a6e22e>Notify</span>(<span style=color:#a6e22e>c4signal</span>, <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Interrupt</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>select</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>c4signal</span>:
</span></span><span style=display:flex><span>		<span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>在可以主动介入程序运行之后，就可以设计主动拒绝新请求的逻辑了。这样可以实现服务不完全停止的情况下，拒绝对外服务。</p><p>因为服务停止不仅仅是不对外服务这么简单，在服务真正的停止之前，还有很多善后的工作需要做。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// HTTPHandler 核心处理逻辑
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>HTTPHandler</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// isRunning 服务是否正在运行
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>isRunning</span> <span style=color:#66d9ef>bool</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>p7this</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>HTTPHandler</span>) <span style=color:#a6e22e>doServeHTTP</span>(<span style=color:#a6e22e>p7ctx</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>HTTPContext</span>) {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 如果服务已经关闭了就直接返回
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>p7this</span>.<span style=color:#a6e22e>isRunning</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>p7ctx</span>.<span style=color:#a6e22e>I9writer</span>.<span style=color:#a6e22e>WriteHeader</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusInternalServerError</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>_</span> = <span style=color:#a6e22e>p7ctx</span>.<span style=color:#a6e22e>I9writer</span>.<span style=color:#a6e22e>Write</span>([]byte(<span style=color:#e6db74>&#34;服务已关闭&#34;</span>))
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>虽然服务停止前有很多善后的工作需要做，但是理论上不会持续很久。</p><p>为了防止意外卡死的情况出现，可以再加一层超时强制停止的逻辑。必要的时候，也可以设计主动强制关闭的入口。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>p7this</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ServiceManager</span>) <span style=color:#a6e22e>Start</span>() {
</span></span><span style=display:flex><span>	<span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 监听 ctrl+c 信号
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>c4signal</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>chan</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Signal</span>, <span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>signal</span>.<span style=color:#a6e22e>Notify</span>(<span style=color:#a6e22e>c4signal</span>, <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Interrupt</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>select</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>c4signal</span>:
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;接收到关闭信号，开始关闭服务，限制 %d 秒内完成。。。\r\n&#34;</span>, <span style=color:#a6e22e>p7this</span>.<span style=color:#a6e22e>shutdownTimeOut</span><span style=color:#f92672>/</span><span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>)
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 再次监听 ctrl+c 信号
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>select</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>c4signal</span>:
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;再次接收到关闭信号，服务直接退出。&#34;</span>)
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Exit</span>(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}()
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>AfterFunc</span>(<span style=color:#a6e22e>p7this</span>.<span style=color:#a6e22e>shutdownTimeOut</span>, <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;优雅关闭超时，服务直接退出。&#34;</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Exit</span>(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>		})
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>p7this</span>.<span style=color:#a6e22e>Shutdown</span>()
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>在拒绝新请求之后，由于有可能还有旧的请求没有处理完，所以是不能立刻就关闭服务的，需要等待一段时间。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>p7this</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ServiceManager</span>) <span style=color:#a6e22e>Shutdown</span>() {
</span></span><span style=display:flex><span>	<span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;停止接收新请求。&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>p7hs</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>p7this</span>.<span style=color:#a6e22e>s5p7HTTPService</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>p7hs</span>.<span style=color:#a6e22e>Stop</span>()
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;等待正在执行的请求结束，等待 %d 秒。。。&#34;</span>, <span style=color:#a6e22e>p7this</span>.<span style=color:#a6e22e>shutdownWaitTime</span><span style=color:#f92672>/</span><span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#a6e22e>p7this</span>.<span style=color:#a6e22e>shutdownWaitTime</span>)
</span></span><span style=display:flex><span>	<span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>服务正式关闭服务之后，可能还有一些收尾的工作需要处理，然后才能彻底退出程序。</p><p>比如：系统里如果有缓存的话，可能需要把缓存进行持久化处理；系统关闭时，需要上报数据其他服务等。</p><p>这个可以通过回调实现，和中间件的用法类似。不过最后执行的时候，是所有的回调是并发执行的，而不是像中间件一样套起来，一次执行的。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>p7this</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ServiceManager</span>) <span style=color:#a6e22e>Shutdown</span>() {
</span></span><span style=display:flex><span>	<span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;开始执行子服务的关闭回调。。。&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>p7hs</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>p7this</span>.<span style=color:#a6e22e>s5p7HTTPService</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;执行子服务 %s 的关闭回调，限制 %d 秒内完成。。。&#34;</span>, <span style=color:#a6e22e>p7hs</span>.<span style=color:#a6e22e>name</span>, <span style=color:#a6e22e>p7this</span>.<span style=color:#a6e22e>shutdownCallbackTimeOut</span><span style=color:#f92672>/</span><span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>f4cb</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>p7hs</span>.<span style=color:#a6e22e>s5f4shutdownCallback</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>t4f4cb</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>f4cb</span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>wg</span>.<span style=color:#a6e22e>Add</span>(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>wg</span>.<span style=color:#a6e22e>Done</span>()
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>t4ctx</span>, <span style=color:#a6e22e>t4cancel</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>WithTimeout</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>(), <span style=color:#a6e22e>p7this</span>.<span style=color:#a6e22e>shutdownCallbackTimeOut</span>)
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>t4cancel</span>()
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>t4f4cb</span>(<span style=color:#a6e22e>t4ctx</span>)
</span></span><span style=display:flex><span>			}()
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>wg</span>.<span style=color:#a6e22e>Wait</span>()
</span></span><span style=display:flex><span>	<span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>到这里核心的部分就差不多了，细节上的实现可以看代码。</p></div><footer class=post-footer><div class=post-tags><a href=/tags/computer-science%e8%ae%a1%e7%ae%97%e6%9c%ba%e7%a7%91%e5%ad%a6>computer-science(计算机科学)</a>
<a href=/tags/programming-language%e7%bc%96%e7%a8%8b%e8%af%ad%e8%a8%80>programming-language(编程语言)</a>
<a href=/tags/framework%e6%a1%86%e6%9e%b6>framework(框架)</a>
<a href=/tags/web>web</a>
<a href=/tags/http>http</a>
<a href=/tags/router%e8%b7%af%e7%94%b1>router(路由)</a>
<a href=/tags/middleware%e4%b8%ad%e9%97%b4%e4%bb%b6>middleware(中间件)</a>
<a href=/tags/golang>golang</a></div><div class=addthis_inline_share_toolbox style=text-align:center></div><hr><div class=post-copyright><img src=/imgs/cc/cc.svg width=75 height=75 align=right><ul><li class=post-copyright-title><strong>文章标题：</strong>
【过期，留做对比】Golang 实现复杂的 Web 框架</li><li class=post-copyright-author><strong>本文作者：</strong>
西柊慧音</li><li class=post-copyright-link><strong>本文链接：</strong>
<a id=post-cr-link href=/post/computer-science/programming-language/framework/web/golang/complex/ title="【过期，留做对比】Golang 实现复杂的 Web 框架">/post/computer-science/programming-language/framework/web/golang/complex/</a></li><li class=post-copyright-license><strong>版权声明：</strong>
本博客所有文章除特别声明外，均采用 <i class="fab fa-fw fa-creative-commons"></i><a target=_blank href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class=post-nav><div class="post-nav-next post-nav-item"><a href=/post/computer-science/programming-language/symbol_naming/ rel=next title=符号命名><i class="fa fa-chevron-left"></i> 符号命名</a></div><div class="post-nav-prev post-nav-item"><a href=/post/computer-science/programmer/ rel=prev title=程序员的定位>程序员的定位
<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div></div></main><footer class=footer><div class=footer-inner><div class=copyright>&copy;
<span itemprop=copyrightYear>2020 - 2023</span>
<span class=with-love><i class="fa fa-heart"></i></span>
<span class=author itemprop=copyrightHolder>西柊慧音</span></div><div class=powered-by>由 <a href=https://gohugo.io title=0.103.1 target=_blank>Hugo</a> & <a href=https://github.com/hugo-next/hugo-theme-next title=4.4.1 target=_blank>Hugo NexT.Gemini</a> 强力驱动</div></div></footer><script type=text/javascript src=https://cdn.staticfile.org/animejs/3.2.1/anime.min.js defer></script>
<script type=text/javascript src=https://cdn.staticfile.org/viewerjs/1.11.0/viewer.min.js defer></script>
<script class=next-config data-name=main type=application/json>{"bookmark":{"color":"#222","enable":true,"save":"manual"},"busuanzi":{"pageview":true},"copybtn":true,"darkmode":false,"giscus":{"cfg":{"category":"Comments","categoryid":null,"emit":false,"inputposition":"top","mapping":"title","reactions":false,"repo":"username/repo-name","repoid":null,"theme":"preferred_color_scheme"},"js":"https://giscus.app/client.js"},"hostname":"/","i18n":{"ds_day":" 天前","ds_days":" 天 ","ds_hour":" 小时前","ds_hours":" 小时 ","ds_just":"刚刚","ds_min":" 分钟前","ds_mins":" 分钟","ds_month":" 个月前","ds_years":" 年 ","empty":"没有找到任何搜索结果：${query}","hits":"","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","placeholder":"搜索..."},"lang":"zh-CN","lazyload":false,"localSearch":{"enable":true,"path":"/searchindexes.xml","preload":false,"topnperarticle":-1,"trigger":"auto","unescape":false},"motion":{"async":true,"enable":true,"transition":{"collheader":"fadeInLeft","postblock":"fadeIn","postbody":"fadeInDown","postheader":"fadeInDown","sidebar":"fadeInUp"}},"root":"/","scheme":"Gemini","sidebar":{"display":"post","offset":12,"padding":18,"position":"left","width":256},"statis":{"enable":false,"plugin":"busuanzi"},"vendor":{"plugins":"qiniu","router":"https://cdn.staticfile.org"},"version":"4.4.1","waline":{"cfg":{"comment":true,"emoji":false,"imguploader":false,"pageview":false,"placeholder":"请文明发言哟 ヾ(≧▽≦*)o","reaction":true,"reactiontext":["点赞","踩一下","得意","不屑","尴尬","睡觉"],"reactiontitle":"你认为这篇文章怎么样？","requiredmeta":["nick","mail"],"serverurl":null,"sofa":"快来发表你的意见吧 (≧∀≦)ゞ","wordlimit":200},"css":{"alias":"waline","file":"dist/waline.css","name":"@waline/client","version":"2.13.0"},"js":{"alias":"waline","file":"dist/waline.js","name":"@waline/client","version":"2.13.0"}}}</script><script type=text/javascript src=/js/main.min.c997eeae723f2fcee19ae5066fcc64a49cefb92ddb75904efdb69a223e5a6740.js defer></script></body></html>