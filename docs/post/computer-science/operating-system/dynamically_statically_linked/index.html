<!doctype html><html lang=zh-cn data-theme=light><head><meta charset=utf-8><meta name=viewport content="width=device-width"><meta name=theme-color content="#222" media="(prefers-color-scheme: light)"><meta name=generator content="Hugo 0.103.1"><link rel="shortcut icon" type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/png sizes=16x16 href=/imgs/icons/favicon_16x16_next.png><link rel=icon type=image/png sizes=32x32 href=/imgs/icons/favicon_32_32_next.png><link rel=apple-touch-icon sizes=180x180 href=/imgs/icons/apple_touch_icon_next.png><meta itemprop=name content="动态链接和静态链接"><meta itemprop=description content><meta itemprop=datePublished zgotmplz><meta itemprop=dateModified zgotmplz><meta itemprop=image content="/image/pid49256268.jpg"><meta itemprop=keywords content="computer-science(计算机科学),operating-system(操作系统),linux,c-programming-language"><meta property="og:type" content="article"><meta property="og:title" content="动态链接和静态链接"><meta property="og:description" content><meta property="og:image" content="/image/pid49256268.jpg"><meta property="og:image:width" content="312"><meta property="og:image:height" content="312"><meta property="og:image:type" content="image/jpeg/png/svg/jpg"><meta property="og:url" content="/post/computer-science/operating-system/dynamically_statically_linked/"><meta property="og:site_name" content="帕里特档案馆"><meta property="og:locale" content="zh-CN"><meta property="article:author" content="西柊慧音"><meta property="article:published_time" content="2023-06-10 08:00:00 +0800 CST"><meta property="article:modified_time" content="2023-06-10 08:00:00 +0800 CST"><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/font-awesome/6.1.2/css/all.min.css><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/animate.css/3.1.1/animate.min.css><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/viewerjs/1.11.0/viewer.min.css><link rel=stylesheet href=/css/main.min.4da9279b6033ade10d67092d7bfb660265f9fa46c40974f17b13bfe235396546.css><style type=text/css>.post-footer,.flinks-list-footer hr:after{content:"~ 我可是有底线的哟 ~"}</style><script type=text/javascript>(function(){localDB={set:function(e,t,n){if(n===0)return;const s=new Date,o=n*864e5,i={value:t,expiry:s.getTime()+o};localStorage.setItem(e,JSON.stringify(i))},get:function(e){const t=localStorage.getItem(e);if(!t)return void 0;const n=JSON.parse(t),s=new Date;return s.getTime()>n.expiry?(localStorage.removeItem(e),void 0):n.value}},theme={active:function(){const e=localDB.get("theme");if(e==null)return;theme.toggle(e),window.matchMedia("(prefers-color-scheme: dark)").addListener(function(e){theme.toggle(e.matches?"dark":"light")})},toggle:function(e){document.documentElement.setAttribute("data-theme",e),localDB.set("theme",e,2);const t=document.querySelector("iframe.giscus-frame");if(t){const n={setConfig:{theme:e}};t.contentWindow.postMessage({giscus:n},"https://giscus.app")}}},theme.active()})(window)</script><script class=next-config data-name=page type=application/json>{"comments":false,"isHome":false,"isPage":true,"path":"dynamically_statically_linked","permalink":"/post/computer-science/operating-system/dynamically_statically_linked/","title":"动态链接和静态链接","waline":{"js":[{"alias":"waline","alias_name":"@waline/client","file":"dist/pageview.js","name":"pageview","version":"2.13.0"},{"alias":"waline","alias_name":"@waline/client","file":"dist/comment.js","name":"comment","version":"2.13.0"}]}}</script><script type=text/javascript>document.addEventListener("DOMContentLoaded",()=>{var e=document.createElement("script");e.charset="UTF-8",e.src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js",e.async=!1,e.defer=!0,document.head.appendChild(e),e.onload=function(){NexT.utils.fmtBusuanzi()}})</script><title>动态链接和静态链接 - 帕里特档案馆</title><noscript><link rel=stylesheet href=/css/noscript.css></noscript></head><body itemscope itemtype=http://schema.org/WebPage class=use-motion><div class=headband></div><main class=main><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div class=toggle aria-label=切换导航栏 role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div></div><div class=site-meta><a href=/ class=brand rel=start><i class=logo-line></i><h1 class=site-title>帕里特档案馆</h1><i class=logo-line></i></a><p class=site-subtitle itemprop=description>重建中</p></div><div class=site-nav-right><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class=site-nav><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href=/ class=hvr-icon-pulse rel=section><i class="fa fa-home hvr-icon"></i>首页</a></li><li class="menu-item menu-item-about"><a href=/about/ class=hvr-icon-pulse rel=section><i class="fa fa-user hvr-icon"></i>关于</a></li><li class="menu-item menu-item-archives"><a href=/archives/ class=hvr-icon-pulse rel=section><i class="fa fa-archive hvr-icon"></i>归档
<span class=badge>96</span></a></li><li class="menu-item menu-item-commonweal"><a href=/404.html class=hvr-icon-pulse rel=section><i class="fa fa-heartbeat hvr-icon"></i>公益 404</a></li><li class="menu-item menu-item-search"><a role=button class="popup-trigger hvr-icon-pulse"><i class="fa fa-search fa-fw hvr-icon"></i>搜索</a></li></ul></nav><div class=search-pop-overlay><div class="popup search-popup"><div class=search-header><span class=search-icon><i class="fa fa-search"></i></span><div class=search-input-container><input autocomplete=off autocapitalize=off maxlength=80 placeholder=搜索... spellcheck=false type=search class=search-input></div><span class=popup-btn-close role=button><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class=search-result-icon><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></div><div class="toggle sidebar-toggle" role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div><aside class=sidebar><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class=sidebar-nav><li class=sidebar-nav-toc>文章目录</li><li class=sidebar-nav-overview>站点概览</li></ul><div class=sidebar-panel-container><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><nav id=TableOfContents><ul><li><a href=#前言>前言</a></li><li><a href=#资料>资料</a></li><li><a href=#正文>正文</a><ul><li><a href=#动态链接>动态链接</a></li><li><a href=#编写和使用动态库>编写和使用动态库</a></li><li><a href=#静态链接>静态链接</a></li></ul></li></ul></nav></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image alt=西柊慧音 src=/imgs/img-lazy-loading.gif data-src=/image/pid49256268.jpg><p class=site-author-name itemprop=name>西柊慧音</p><div class=site-description itemprop=description></div></div><div class="site-state-wrap site-overview-item animated"><nav class=site-state><div class="site-state-item site-state-posts"><a href=/archives/><span class=site-state-item-count>96</span>
<span class=site-state-item-name>日志</span></a></div><div class="site-state-item site-state-categories"><a href=/categories/><span class=site-state-item-count>17</span>
<span class=site-state-item-name>分类</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/><span class=site-state-item-count>64</span>
<span class=site-state-item-name>标签</span></a></div></nav></div><div class="links-of-social site-overview-item animated"><span class=links-of-social-item><a href=https://github.com/KelipuTe title="Github → https://github.com/KelipuTe" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-github fa-fw hvr-icon"></i>Github</a></span>
<span class=links-of-social-item><a href=xhy_1365@sina.com title="E-Mail → xhy_1365@sina.com" rel=noopener class=hvr-icon-pulse target=_blank><i class="fa fa-envelope fa-fw hvr-icon"></i>E-Mail</a></span></div><div class="cc-license animated" itemprop=license><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh class=cc-opacity rel=noopener target=_blank title=共享知识><img src=/imgs/img-lazy-loading.gif data-src=/imgs/cc/big/by_nc_sa.svg alt=共享知识></a></div><div class="links-of-blogroll site-overview-item animated"><div class=links-of-blogroll-title><i class="fa fa-globe fa-fw"></i>友情链接</div><ul class=links-of-blogroll-list><li class=links-of-blogroll-item><a href=https://gitee.com/hugo-next/hugo-theme-next title=https://gitee.com/hugo-next/hugo-theme-next target=_blank>Hugo-NexT</a></li><li class=links-of-blogroll-item><a href=https://lisenhui.cn title=https://lisenhui.cn target=_blank>凡梦星尘空间站</a></li></ul></div></div></div></div></aside><div class=sidebar-dimmer></div></header><div class=tool-buttons><div id=toggle-theme class=button title=深浅模式切换><i class="fas fa-adjust"></i></div><div class=back-to-top role=button title=返回顶部><i class="fa fa-arrow-up"></i>
<span>0%</span></div></div><div class=reading-progress-bar></div><a role=button class="book-mark-link book-mark-link-fixed"></a>
<a href=https://github.com/hugo-next rel="noopener external nofollow noreferrer" target=_blank title="Follow me on GitHub" class="exturl github-corner"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentcolor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentcolor" class="octo-body"/></svg></a><noscript><div class=noscript-warning>Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class=post-block><article itemscope itemtype=http://schema.org/Article class=post-content lang><link itemprop=mainEntityOfPage href=/post/computer-science/operating-system/dynamically_statically_linked/><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content="/image/pid49256268.jpg"><meta itemprop=name content="西柊慧音"></span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="西柊慧音"><meta itemprop=description content></span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork><meta itemprop=name content="动态链接和静态链接"><meta itemprop=description content="动态链接；静态链接；"></span><header class=post-header><h1 class=post-title itemprop="name headline">动态链接和静态链接</h1><div class=post-meta-container><div class=post-meta-items><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar"></i></span>
<span class=post-meta-item-text>发表于：</span>
<time title="发表于：2023-06-10 08:00:00 +0800 CST" itemprop="dateCreated datePublished" datetime="2023-06-10 08:00:00 +0800 CST">2023-06-10</time></span>
<span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-folder-open"></i></span>
<span class=post-meta-item-text>分类于：</span>
<span itemprop=about itemscope itemtype=http://schema.org/Thing><a href=/categories/operating-system%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F itemprop=url rel=index><span itemprop=name>operating-system(操作系统)</span></a></span></span></div><div class=post-meta-items><span class=post-meta-item title=字数><span class=post-meta-item-icon><i class="far fa-file-word"></i></span>
<span class=post-meta-item-text>字数：</span><span>2341</span></span>
<span class=post-meta-item title=阅读><span class=post-meta-item-icon><i class="far fa-clock"></i></span>
<span class=post-meta-item-text>阅读：&ap;</span>
<span>5分钟</span></span>
<span class=post-meta-item title=浏览><span class=post-meta-item-icon><i class="far fa-eye"></i></span>
<span class=post-meta-item-text>浏览：</span>
<span id=busuanzi_value_page_pv data-path=/post/computer-science/operating-system/dynamically_statically_linked/><i class="fa fa-sync fa-spin"></i></span></span></div></div></header><div class="post-body autonumber" itemprop=articleBody><h2 id=前言>前言</h2><p>实践的环境：</p><ul><li>amd64（x86_64）</li><li>windows 11</li><li>vmware workstation pro 16</li><li>ubuntu 22.04</li><li>linux version 5.19.0-41-generic</li><li>gcc version 11.3.0</li></ul><p>前置笔记：
<a href=/post/computer-science/operating-system/linux/exec_elf title="运行 ELF 文件">运行 ELF 文件</a></p><h2 id=资料>资料</h2><ul><li><a href=https://github.com/KelipuTe/demo-c title={demo-c} rel="noopener external nofollow noreferrer" target=_blank class=exturl>{demo-c}
<i class="fa fa-external-link-alt"></i>
</a>/demo-in-linux/program/</li><li><a href=https://github.com/KelipuTe/demo-c title={demo-c} rel="noopener external nofollow noreferrer" target=_blank class=exturl>{demo-c}
<i class="fa fa-external-link-alt"></i>
</a>/demo-in-linux/dynamically-statically-linked/</li></ul><h2 id=正文>正文</h2><h3 id=动态链接>动态链接</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-text data-lang=text><span style=display:flex><span>&gt; file hello_world.elf
</span></span><span style=display:flex><span>hello_world.elf: ELF 64-bit LSB pie executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=6d49e18a785eb53d246ca89c5dbce54472ed1584, for GNU/Linux 3.2.0, not stripped
</span></span></code></pre></div><p>之前我们通过 file 命令查看 hello_world.elf 的文件类型时说过，它是 &ldquo;dynamically linked&rdquo; 的，也就是动态链接的。
如果一个 elf 可执行文件是动态链接的。那么，它必定有一个解释器，这个解释器就是 linux 动态链接器。
在这里就是 &ldquo;interpreter /lib64/ld-linux-x86-64.so.2&rdquo; 这一段。interpreter 就是解释器的意思，后面的是解释器的路径。</p><p>有的时候动态链接的信息可以从 file 命令的结果里可以直接看见。
如果没有的话，也可以通过 readelf 命令，从 elf 文件的 program headers 中找到。
这里截取了 readelf 命令的输出中关于解释器的那一部分。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>Program Headers:
</span></span><span style=display:flex><span>  Type           Offset             VirtAddr           PhysAddr
</span></span><span style=display:flex><span>                 FileSiz            MemSiz              Flags  Align
</span></span><span style=display:flex><span>  INTERP         0x0000000000000318 0x0000000000000318 0x0000000000000318
</span></span><span style=display:flex><span>                 0x000000000000001c 0x000000000000001c  R      0x1
</span></span><span style=display:flex><span>      [Requesting program interpreter: /lib64/ld-linux-x86-64.so.2]
</span></span></code></pre></div><p>前面我们也提到过 &ldquo;.interp&rdquo; 段（上面的 INTERP）里面，存的就是程序解释器（elf 解释器）的路径。</p><p>这里的就是这个 &ldquo;interpreter: /lib64/ld-linux-x86-64.so.2&rdquo;，它就是 linux 动态链接器。
它的功能是，把 elf 程序所依赖的动态库（共享库）加载并初始化。</p><p>如果 elf 可执行程序的类型是动态链接的话，那么这个程序加载到内存运行时，操作系统会把控制权先交给动态链接器。
动态链接器加载完该程序所依赖的动态库并初始化相应的必要操作后，才会把控制权交给程序的入口地址。
如果这个程序没有 &ldquo;.interp&rdquo; 段，就会直接从程序的入口地址直接执行。</p><p>也就是说，linux 在使用 execve() 加载程序时。不管 elf 文件的具体类型是什么。
只要检测出含有 &ldquo;.interp&rdquo; 段，那么，linux 就会先运行动态链接器。
动态链接器运行完之后，才会将控制权交给 elf 程序的入口地址。</p><p>可以通过 ldd 命令查看文件依赖的动态库。
关于 ldd 命令具体怎么用，可以看 &ldquo;ldd(1) - print shared object dependencies&rdquo;。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>&gt; ldd hello_world.elf
</span></span><span style=display:flex><span>	linux-vdso.so.1 (0x00007fffafdd6000)
</span></span><span style=display:flex><span>	libc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007f6d35e00000)
</span></span><span style=display:flex><span>	/lib64/ld-linux-x86-64.so.2 (0x00007f6d3620c000)
</span></span></code></pre></div><p>&ldquo;/lib64/ld-linux-x86-64.so.2&rdquo; 就是动态链接器。
通过 <code>file /lib64/ld-linux-x86-64.so.2</code> 命令，可以查看它的文件类型。</p><p>结果是："/lib64/ld-linux-x86-64.so.2: symbolic link to /lib/x86_64-linux-gnu/ld-linux-x86-64.so.2"
其中 &ldquo;symbolic link to&rdquo; 表示它是个软链接。链接到的 &ldquo;ld-linux-x86-64.so.2&rdquo; 是个特殊的共享库文件，因为它可以执行。</p><p>&ldquo;/lib/x86_64-linux-gnu/libc.so.6&rdquo; 就是依赖的动态库。它是 c 的运行库，封装了很多操作系统的接口。
libc.so.6 是 GNU c 库（glibc）的一个重要组成部分，是大多数 linux 发行版使用的标准 c 库。</p><p>linux 系统中，c 库的命名规则通常遵循 libc.so.&lt;版本> 的模式，libc.so.6 就表示它是 c 库的第 6 版。</p><p>动态库允许多个程序在内存中共享同一实例，减少内存消耗，并使动态库的更新变得容易，而不需要重新编译所有依赖它的程序。
这样程序就可以以模块的形式独立开发，并且方便后续的维护和升级。</p><p>动态库的查找路径："/usr/lib"、"/usr/lib64" 存储的是操作系统的共享库；
&ldquo;/usr/local/lib&rdquo;、"/usr/local/lib64"存储的是第三方的共享库。</p><p>&ldquo;linux-vdso.so.1&rdquo;，它是比较特殊的一个共享库，它不在文件系统中，而是在内核中。
详细的可以看：&ldquo;vdso(7) - overview of the virtual ELF dynamic shared object&rdquo;。</p><h3 id=编写和使用动态库>编写和使用动态库</h3><p>我在 &ldquo;{demo-c}/demo-in-linux/dynamically-statically-linked/&rdquo; 目录下准备了样例代码。</p><p>dynamically_library.c 是动态库本体。里面准备了一个 print_hello_world()。
编码完成后使用 <code>gcc -fPIC -shared dynamically_library.c -o dynamically_library.so</code> 命令，编译成动态库。</p><p>动态库一般有两种使用方式：编译时链接动态库（写代码的时候引入头文件，头文件里面是声明和定义）；程序中显示调用动态库。</p><p>首先是编译时使用动态库，我们在 use_when_gcc.c 里面直接声明然后调用 print_hello_world()。
这个时候直接使用 gcc 编译肯定是不行的，因为标准库里面没有 print_hello_world()。</p><p>需要使用 <code>gcc use_when_gcc.c ./dynamically_library.so -o use_when_gcc.elf</code> 命令，在编译时连接动态库。</p><p>在程序中显示调用动态库比较麻烦，需要借助几个系统调用：dlopen()、dlsym()。代码在 use_in_code.c 里面。
这个编译的时候这样写 <code>gcc use_in_code.c -ldl -o use_in_code.elf</code>，不需要连接动态库。</p><h3 id=静态链接>静态链接</h3><p>如果通过 file 命令查看静态链接的 elf 可执行文件的话，结果中会有 &ldquo;statically linked&rdquo;。
静态链接的程序，会直接从程序的入口地址开始执行。</p><p>我这里准备了 2 个文件，statically_library.c、statically_use.c</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>// statically_library.c
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>returnVal</span> (<span style=color:#66d9ef>int</span> v){
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> v;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>// statically_use.c
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdio.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>  returnVal(<span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>使用 gcc 先将两个文件编译成可重定位文件。
<code>gcc -c statically_library.c -o statically_library.o</code>。
<code>gcc -c statically_use.c -o statically_use.o</code>。</p><p>编译 statically_use.c 的时候会报错，这个忽略就好，这玩意肯定是有问题的。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-text data-lang=text><span style=display:flex><span>statically_use.c: In function ‘main’:
</span></span><span style=display:flex><span>statically_use.c:4:3: warning: implicit declaration of function ‘returnVal’ [-Wimplicit-function-declaration]
</span></span><span style=display:flex><span>    4 |   returnVal(1);
</span></span><span style=display:flex><span>      |   ^~~~~~~~~
</span></span></code></pre></div><p>这个时候我们使用 objdump 命令分别看一下 statically_library.o 和 statically_use.o。
这里截取了 &ldquo;.text&rdquo; 段的内容，要和下面 statically_call.elf 的对比着看的。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-text data-lang=text><span style=display:flex><span>&gt; objdump -s statically_library.o
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Contents of section .text:
</span></span><span style=display:flex><span> 0000 f30f1efa 554889e5 897dfc8b 45fc5dc3  ....UH...}..E.].
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-text data-lang=text><span style=display:flex><span>&gt; objdump -s statically_use.o
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Contents of section .text:
</span></span><span style=display:flex><span> 0000 f30f1efa 554889e5 bf010000 00b80000  ....UH..........
</span></span><span style=display:flex><span> 0010 0000e800 000000b8 00000000 5dc3      ............].  
</span></span></code></pre></div><p>然后，这里用的不是 gcc 了，用的是静态链接器 ld，用 gcc 的时候，它会自动调用 ld。
链接 statically_library.o 和 statically_use.o 并设置程序入口为 main。
<code>ld statically_library.o statically_use.o -e main -o statically_call.elf</code>。</p><p>这个时候就得到了一个 elf 可执行文件。这玩意跑不起来，因为除了这两段代码别的啥都没有。
用 file 命令看一下，可以看到输出的结果里面有 &ldquo;statically linked&rdquo;。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-text data-lang=text><span style=display:flex><span>&gt; file statically_call.elf 
</span></span><span style=display:flex><span>statically_call.elf: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), statically linked, not stripped
</span></span></code></pre></div><p>再使用 objdump 命令看一下 statically_call.elf。可以发现 &ldquo;.text&rdquo; 段的内容，就是上面两个文件拼起来的。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-text data-lang=text><span style=display:flex><span>&gt; objdump -s statically_call.elf
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Contents of section .text:
</span></span><span style=display:flex><span> 401000 f30f1efa 554889e5 897dfc8b 45fc5dc3  ....UH...}..E.].
</span></span><span style=display:flex><span> 401010 f30f1efa 554889e5 bf010000 00b80000  ....UH..........
</span></span><span style=display:flex><span> 401020 0000e8d9 ffffffb8 00000000 5dc3      ............].  
</span></span></code></pre></div><p>静态链接器会将输入的目标文件进行合并，把 &ldquo;.text&rdquo; 段、".data" 段等进行合并，合并后会重新计算段的大小、偏移位置。
同时静态链接器还要完成符号解析（确保所有的符号被正确地连接）、重新定位（调整内存地址和引用）等操作。</p></div><footer class=post-footer><div class=post-tags><a href=/tags/computer-science%e8%ae%a1%e7%ae%97%e6%9c%ba%e7%a7%91%e5%ad%a6>computer-science(计算机科学)</a>
<a href=/tags/operating-system%e6%93%8d%e4%bd%9c%e7%b3%bb%e7%bb%9f>operating-system(操作系统)</a>
<a href=/tags/linux>linux</a>
<a href=/tags/c-programming-language>c-programming-language</a></div><div class=addthis_inline_share_toolbox style=text-align:center></div><hr><div class=post-copyright><img src=/imgs/cc/cc.svg width=75 height=75 align=right><ul><li class=post-copyright-title><strong>文章标题：</strong>
动态链接和静态链接</li><li class=post-copyright-author><strong>本文作者：</strong>
西柊慧音</li><li class=post-copyright-link><strong>本文链接：</strong>
<a id=post-cr-link href=/post/computer-science/operating-system/dynamically_statically_linked/ title=动态链接和静态链接>/post/computer-science/operating-system/dynamically_statically_linked/</a></li><li class=post-copyright-license><strong>版权声明：</strong>
本博客所有文章除特别声明外，均采用 <i class="fab fa-fw fa-creative-commons"></i><a target=_blank href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class=post-nav><div class="post-nav-next post-nav-item"><a href=/post/computer-science/operating-system/program/ rel=next title=程序><i class="fa fa-chevron-left"></i> 程序</a></div><div class="post-nav-prev post-nav-item"><a href=/post/computer-science/operating-system/linux/exec_elf/ rel=prev title="运行 ELF 文件">运行 ELF 文件
<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div></div></main><footer class=footer><div class=footer-inner><div class=copyright>&copy;
<span itemprop=copyrightYear>2020 - 2023</span>
<span class=with-love><i class="fa fa-heart"></i></span>
<span class=author itemprop=copyrightHolder>西柊慧音</span></div><div class=powered-by>由 <a href=https://gohugo.io title=0.103.1 target=_blank>Hugo</a> & <a href=https://github.com/hugo-next/hugo-theme-next title=4.4.1 target=_blank>Hugo NexT.Gemini</a> 强力驱动</div></div></footer><script type=text/javascript src=https://cdn.staticfile.org/animejs/3.2.1/anime.min.js defer></script>
<script type=text/javascript src=https://cdn.staticfile.org/viewerjs/1.11.0/viewer.min.js defer></script>
<script class=next-config data-name=main type=application/json>{"bookmark":{"color":"#222","enable":true,"save":"manual"},"busuanzi":{"pageview":true},"copybtn":true,"darkmode":false,"giscus":{"cfg":{"category":"Comments","categoryid":null,"emit":false,"inputposition":"top","mapping":"title","reactions":false,"repo":"username/repo-name","repoid":null,"theme":"preferred_color_scheme"},"js":"https://giscus.app/client.js"},"hostname":"/","i18n":{"ds_day":" 天前","ds_days":" 天 ","ds_hour":" 小时前","ds_hours":" 小时 ","ds_just":"刚刚","ds_min":" 分钟前","ds_mins":" 分钟","ds_month":" 个月前","ds_years":" 年 ","empty":"没有找到任何搜索结果：${query}","hits":"","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","placeholder":"搜索..."},"lang":"zh-CN","lazyload":false,"localSearch":{"enable":true,"path":"/searchindexes.xml","preload":false,"topnperarticle":-1,"trigger":"auto","unescape":false},"motion":{"async":true,"enable":true,"transition":{"collheader":"fadeInLeft","postblock":"fadeIn","postbody":"fadeInDown","postheader":"fadeInDown","sidebar":"fadeInUp"}},"root":"/","scheme":"Gemini","sidebar":{"display":"post","offset":12,"padding":18,"position":"left","width":256},"statis":{"enable":false,"plugin":"busuanzi"},"vendor":{"plugins":"qiniu","router":"https://cdn.staticfile.org"},"version":"4.4.1","waline":{"cfg":{"comment":true,"emoji":false,"imguploader":false,"pageview":false,"placeholder":"请文明发言哟 ヾ(≧▽≦*)o","reaction":true,"reactiontext":["点赞","踩一下","得意","不屑","尴尬","睡觉"],"reactiontitle":"你认为这篇文章怎么样？","requiredmeta":["nick","mail"],"serverurl":null,"sofa":"快来发表你的意见吧 (≧∀≦)ゞ","wordlimit":200},"css":{"alias":"waline","file":"dist/waline.css","name":"@waline/client","version":"2.13.0"},"js":{"alias":"waline","file":"dist/waline.js","name":"@waline/client","version":"2.13.0"}}}</script><script type=text/javascript src=/js/main.min.c997eeae723f2fcee19ae5066fcc64a49cefb92ddb75904efdb69a223e5a6740.js defer></script></body></html>