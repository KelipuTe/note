---
draft: false
date: 2022-08-05 08:00:00 +0800
lastmod: 2022-08-05 08:00:00 +0800
title: "2-3-4 树"
summary: "2-3-4 树的插入、平衡、删除。"

categories:
  - data-structure(数据结构)

tags:
  - computer-science(计算机科学)
  - data-structure(数据结构)
  - b-tree
---

### 前言

在看 2-3-4 树之前，建议先看 2-3 树。相似的操作在 2-3-4 树不会重复详细的描述。

### 资料

- <a href="/drawio/computer-science/data-structure/2-3-4_tree.drawio.html">2-3-4_tree.drawio.html</a>

### 2-3-4 树

- 2-3-4 树就是 4 阶 B-树
- 2-3-4 树和红黑树是等价的：
  - 2-3-4 树的结点个数 = 红黑树的黑色结点个数。
  - 把 2-3-4 树的三结点和四结点拆开，就可以变成红黑树。
  - 把红黑树的红结点移动到和父结点同层，就会变成 2-3-4 树。

### 2-3-4 树的性质

1、满足二叉查找树的基本性质。

2、结点可以存放一个元素、两个元素。
  - 假设结点结构从左到右分别为：`子树 1、元素 1、子树 2、元素 2、子树 3、元素 3、子树 4`。
  - 对于存放一个元素的结点。其形态为：`子树 1、元素 1、子树 2`。
    - `子树 1` 存放比 `元素 1` 小的元素；
    - `子树 2` 存放比 `元素 1` 大的元素。
  - 对于存放两个元素的结点，其形态为：`子树 1、元素 1、子树 2、元素 2、子树 3`。
    - `子树 1` 存放比 `元素 1` 和 `元素 2` 都小的元素；
    - `子树 2` 存放在 `元素 1` 和 `元素 2` 之间的元素；
    - 子树 3 存放比 `元素 1` 和 `元素 2` 都大的元素。
  - 对于存放三个元素的结点，其形态为：`子树 1、元素 1、子树 2、元素 2、子树 3、元素 3、子树 4`。
    - `子树 1` 存放比 `元素 1`、`元素 2`、`元素 3` 都小的元素；
    - `子树 2` 存放在 `元素 1` 和 `元素 2` 之间的元素；
    - 子树 3 存放在 `元素 2` 和 `元素 3` 之间的元素；
    - `子树 4` 存放比 `元素 1`、`元素 2`、`元素 3` 都大的元素。

3、2-3-4 树是绝对平衡的二叉查找树，所有叶子结点都在同一层上。从根结点到任意一个叶子结点所经过的结点数是相同的。

### 2-3-4 树的插入

**下面列举的情况并不一定覆盖所有的场景，但是典型场景都有了，没有提到的场景可以根据典型场景推导。**

#### 只上溢不旋转的情况

1、空树。（类似 2-3 树的第 1 种情况）

2、二结点。（类似 2-3 树的第 2 种情况）

3、三结点。

添加结点 => 变四结点。（见图：**2-3-4_tree.drawio.html 2-2-6**）

4、没有父结点的四结点。

添加结点 => 变五结点 => 上溢（层数增加）。（见图：**2-3-4_tree.drawio.html 2-4-2**）

5、有父结点的四结点（父结点不是四结点）。

添加结点 => 变五结点 => 上溢（层数不增加）。（见图：**2-3-4_tree.drawio.html 2-4-4**）

这种情况，四结点是父结点哪个子结点，都是一样的处理逻辑，上溢一次。

这里，父结点可以是二结点也可以是三结点。

6、有父结点的四结点（父结点是四结点）。

添加结点 => 变五结点 => 上溢（父结点变五结点）=> 父结点上溢（层数增加）。（见图：**2-3-4_tree.drawio.html 2-6**）

这种情况，四结点是父结点哪个子结点，都是一样的处理逻辑，上溢两次。

#### 可以通过旋转抵消上溢的情况

1、有父结点的四结点（父结点是四结点、兄弟结点不是四结点）。

添加结点 => 变五结点 => 兄弟结点有空位 => 旋转结点到兄弟结点（抵消上溢，层数不增加）。

这种情况，如果只上溢的话，会上溢两次（自己上溢一次、父结点上溢一次），树的深度增加了，可能影响查询效率。

但是这个时候其实 2-3-4 树是不满的，兄弟结点是有空位的。这时候就可以通过旋转，重新平衡 2-3-4 树。

根据 2-3-4 树有空位的兄弟结点的位置，旋转的情况分为六种，处理方式是差不多的：

- 向右旋转一次（见图：**2-3-4_tree.drawio.html 4-2-2**）
- 向左旋转一次（见图：**2-3-4_tree.drawio.html 4-2-4**）
- 向右旋转两次（见图：**2-3-4_tree.drawio.html 4-6**）
- 向左旋转两次（无图，参考向右旋转两次的图）。
- 向右旋转三次（无图，参考向右旋转两次的图）。
- 向左旋转三次（无图，参考向右旋转两次的图）。

2、有父结点的四结点（父结点是四结点、兄弟结点是四结点、祖父结点是四结点、叔叔结点不是四结点）。

添加结点 => 变五结点 => 父结点和兄弟结点都没有空位，无法旋转，只能上溢（父结点变五结点） => 叔叔结点有空位 => 旋转结点到叔叔结点（抵消上溢，层数不增加）。

这种情况，如果只上溢的话，会上溢三次（自己上溢一次、父结点上溢一次、祖父结点上溢一次），树的深度增加了，可能影响查询效率。

但是这个时候其实 2-3-4 树是不满的，叔叔结点是有空位的。这时候就可以通过旋转，重新平衡 2-3-4 树。

这里第一次的上溢是避免不了的。上溢之后，重新以父结点为参照，这时就可以看做上面第一种情况。

根据 2-3-4 树有空位的叔叔结点的位置，旋转的情况分为六种，处理方式是差不多的：

- （上溢一次后）向右旋转一次（无图，参考向右旋转三次的图）。
- （上溢一次后）向左旋转一次（无图，参考向右旋转三次的图）。
- （上溢一次后）向右旋转两次（无图，参考向右旋转三次的图）。
- （上溢一次后）向左旋转两次（无图，参考向右旋转三次的图）。
- （上溢一次后）向右旋转三次（见图：**2-3-4_tree.drawio.html 4-8**）
- （上溢一次后）向左旋转三次（无图，参考向右旋转三次的图）。

### 2-3-4 树的删除

**下面列举的情况并不一定覆盖所有的场景，但是典型场景都有了，没有提到的场景可以根据典型场景推导。**

#### 删除叶子结点

1、删除三结点的结点。（类似 2-3 树的第 1 种情况）

2、删除四结点的结点。

直接删掉就好了，不会破坏 2-3-4 树的性质。（见图：**2-3-4_tree.drawio.html 6-2-4**）

3、删除二结点的结点（父结点是二结点、兄弟结点是二结点）。（类似 2-3 树的第 2 种情况）

4、删除二结点的结点（父结点是三结点、兄弟结点是二结点）。（类似 2-3 树的第 3 种情况）

5、删除二结点的结点（父结点是四结点，兄弟结点是二结点）。（类似第 3 种情况）

删除结点 => 父结点少一个子树 => 父结点**下溢**（其中一个结点，层次不变） => 下溢结点和兄弟结点**融合**。（见图：**2-3-4_tree.drawio.html 6-4-6**）

6、删除二结点的结点（父结点是二结点、兄弟结点是三结点）。（类似 2-3 树的第 4 种情况）

7、删除二结点的结点（父结点是三结点、兄弟结点是三结点）。（类似 2-3 树的第 5 种情况）

8、删除二结点的结点（父结点是四结点、兄弟结点是三结点）。（类似第 6 种情况）

删除结点 => 父结点少一个子树 => 兄弟结点可以借一个结点 => **旋转**结点到删除结点的位置。（见图：**2-3-4_tree.drawio.html 6-6-6**）

另外，还有向左旋转三次的情况（见图：**2-3-4_tree.drawio.html 6-10-4**），向右旋转三次的处理方式是一样的。

9、删除二结点的结点（父结点是二结点、兄弟结点是四结点）。

删除结点 => 父结点少一个子树 => 兄弟结点可以借一个结点 => **旋转**结点到删除结点的位置。（见图：**2-3-4_tree.drawio.html 6-8-2**）

这种情况，删掉结点之后，自己这个位置就是空的了。也就是父结点变得少一个子树，这会破坏 2-3-4 树的性质。

和上面第 3 种情况不同的是，在第 3 种情况中，兄弟结点是二结点，借不出结点。而这里可以借一个结点过来，把这个子树补上，这样就不破坏 2-3-4 树的性质了。

图里的例子是向左旋转一次的情况，向右旋转一次的处理方式是一样的。

10、删除二结点的结点（父结点是三结点、兄弟结点是四结点）。（类似第 9 种情况）

删除结点 => 父结点少一个子树 => 兄弟结点可以借一个结点 => **旋转**结点到删除结点的位置。（见图：**2-3-4_tree.drawio.html 6-8-4**）

11、删除二结点的结点（父结点是四结点、兄弟结点是四结点）。（类似第 9 种情况）

删除结点 => 父结点少一个子树 => 兄弟结点可以借一个结点 => **旋转**结点到删除结点的位置。（见图：**2-3-4_tree.drawio.html 6-8-6**）

12、删除二结点的结点（父结点是二结点、兄弟结点是二结点、祖父结点是二结点、叔叔结点是二结点）。（类似 2-3 树的第 6 种情况）

13、删除二结点的结点（父结点是二结点、兄弟结点是二结点、祖父结点是三结点、叔叔结点是二结点）。（类似 2-3 树的第 7 种情况）

祖父结点是四结点的处理逻辑是一样的。

14、删除二结点的结点（父结点是二结点、兄弟结点是二结点、祖父结点是三结点、叔叔结点是三结点）。（类似 2-3 树的第 8 种情况）

叔叔结点是四结点的处理逻辑是一样的。

#### 删除的不是叶子结点

这种情况需和平衡二叉树一样，找到中序遍历的前驱结点或者后继结点，把这两个结点互换位置，这个时候要删除的结点会被换到叶子结点的位置，然后再删除。

### 2-3-4 树转换成红黑树

- 1、三结点其中一个元素转化为红黑树的红结点，左右哪个元素都可以。四结点中两边的元素转化为红黑树的红结点。
- 2、拆分三结点和四结点，和父结点连接的一定是黑结点
- （见图：**2-3-4_tree.drawio.html 12-2**）

### reference（参考）

- [掌握了2-3-4树也就掌握了红黑树，不信进来看看，建议收藏！ ](https://www.bilibili.com/read/cv12410219)
- [理解2-3-4树](https://www.cnblogs.com/sfencs-hcy/p/10363259.html)
- [bilibili--木子喵neko](https://space.bilibili.com/27735697)
    - [【neko】红黑树/插入【算法编程#11】](https://www.bilibili.com/video/BV1BB4y1X7u3)
    - [【neko】红黑树/删除【算法编程#12】](https://www.bilibili.com/video/BV1Ce4y1Q76H)