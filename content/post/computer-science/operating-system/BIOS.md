---
draft: false
date: 2023-04-07 08:00:00 +0800
title: "BIOS"
summary: "BIOS；引导程序；操作系统；"
toc: true

categories:
  - operating-system(操作系统)

tags:
  - computer-science(计算机科学)
  - bios
---

## 正文

### BIOS

之前的笔记，大概描述了一下 CPU 的基本运行原理。

[CPU_执行程序的过程](/post/computer-science/hardware/CPU_执行程序的过程)

这里面有一个问题没有讨论，那段程序怎么装到内存里去。

最简单的方法是，直接把程序烧录进内存。如果这么做的话，内存里的数据就是固定的，每次读都一样。
那么这块内存，就不能装载不同的程序，进而达到执行不同的任务的目的。换句话说就是，没有通用性。

现在的计算机里的内存，每次启动的时候都是空的，可以根据需要装载不同的程序到内存中而不用替换内存的。
所以，这里肯定不是直接把程序烧录进内存的。但是，想要让计算机能够装载不同的程序到内存中，这本身又是需要程序去处理的。

就是说，计算机启动之后，需要有一个程序去实现装载不同的程序的功能，但是，这个程序又不能直接烧录进内存。
那么怎么办呢？分开喽。用一块内存专门存储这个程序，然后，用另外一块内存来装载不同的程序。

现在我们都知道了，内存可以分为只读内存（read-only memory，ROM）和随机存取内存（Random Access Memory，RAM）。
那个实现装载不同的程序到内存中的程序，就是基本输入输出系统（Basic Input/Output System、BIOS）。

BIOS 是烧录在主板上的 ROM 里面的，一般在计算机主板的非易失性存储芯片上。
它属于固件，负责提供低级别的软件，控制计算机的硬件组件，使其能够启动和运行操作系统。
计算机启动的时候，干的第一件事情，就是运行 BIOS 程序。有了 BIOS 才能干后面的事情。

### 硬件自检

BIOS 程序干的第一件事情是进行检查，检查计算机硬件能不能满足基本的运行条件。
这个过程叫硬件自检（power-on self-test，POST）。

硬件自检的时候还会识别连接到计算机的设备，比如：显示器、硬盘、键盘、鼠标、等。

如果硬件有问题，主板就会发出蜂鸣。比如，内存条没插好的话，一般会 "滴~" 一下。
如果硬件没有问题，显示器就会显示硬件的信息。

硬件自检完成之后，BIOS 会搜索引导程序，然后，把计算机的控制权转交它。

### 引导程序

#### 启动顺序

引导程序负责将操作系统加载到内存中。引导程序通常位于外部存储器上。
比如：硬盘（系统盘）的第一个扇区；可启动的 USB 驱动器（装机盘）；CD-ROM（装机光碟）。

计算机的外部存储器可以有好几个，在 BIOS 的操作界面可以设置这些外部存储器的优先级。指定 BIOS 应该先去那个设备上寻找引导程序。
如果在第一块硬盘的第一个扇区没有找到引导程序，BIOS 将按照启动设备的优先级在其他设备上寻找它，比如，第二块硬盘。

启动设备的优先级叫作启动顺序（boot sequence），存储在 CMOS（互补金属氧化物半导体）存储器中，
它是一种非易失性存储器，用于存储 BIOS 设置和配置。CMOS 存储器数量很少，它由主板上的电池供电。

#### 主引导记录

这里用硬盘的第一个扇区为例。扇区是磁盘操作的最小可寻址单位，通常每个扇区有 512 个字节的存储容量。
如果硬盘的第一个扇区的最后两个字节是 0x55 和 0xAA，那么表示这个设备可以用于启动。

这最前面的 512 个字节，就叫做主引导记录（Master boot record、MBR）。主引导记录只有 512 个字节，放不了太多东西。
它的主要作用是，告诉计算机到硬盘的哪一个位置去找操作系统。

主引导记录由三个部分组成。第 1-446 字节：调用操作系统的机器码。
第 447-510 字节：分区表（Partition table）。第 511-512 字节：主引导记录签名（0x55 和 0xAA）。

#### 分区表

分区表的作用是将硬盘分成若干个区，每个区可以安装不同的操作系统。因此，主引导记录必须知道将控制权转交给哪个区。

分区表的长度有 64 个字节，里面又分成四项，每项 16 个字节。也就是说，一个硬盘最多只能分四个主分区（一级分区）。
每个主分区的 16 个字节，由 6 个部分组成。

第 1 个字节：如果为 0x80，就表示该主分区是激活分区，控制权要转交给这个分区。
四个主分区里面只能有一个是激活的。第 2-4 个字节：主分区第一个扇区的物理位置（柱面、磁头、扇区号等等）。

第 5 个字节：主分区类型。第 6-8 个字节：主分区最后一个扇区的物理位置。
第 9-12 字节：该主分区第一个扇区的逻辑地址。第 13-16 字节：主分区的扇区总数。

随着硬盘越来越大，四个主分区已经不够了，需要更多的分区。
但是，分区表只有四项，因此规定有且仅有一个区可以被定义成扩展分区（Extended partition）。
扩展分区里面又分成多个区，叫做逻辑分区（logical partition）。

扩展分区中的每个逻辑驱动器的分区信息都存在一个类似于 MBR 的扩展引导记录（Extended boot record、EBR）中。
它里面也包含一张 64 字节的分区表，但是最多只有两项（也就是两个逻辑分区）。

第一项描述一个逻辑分区，第二项描述下一个扩展分区。如果不存在下一个扩展分区，第二项就不需要使用。
扩展分区的整个结构就像个链表，理论上可以包含无数个逻辑分区。

#### 找到操作系统

找操作系统分为三种情况：

从主分区启动：如果分区表的四个主分区里面只有一个是激活的，
计算机会读取激活分区的第一个扇区，叫做卷引导记录（volume boot record、VBR）。

卷引导记录的主要作用是，告诉计算机，操作系统在这个分区里的位置。然后，计算机就会加载操作系统了。

从扩展分区启动：一般不这么干，如果操作系统确实安装在扩展分区，那么一般会用启动管理器（引导装载程序）。

启动管理器（boot loader）：计算机读取主引导记录前面 446 个字节之后，不再把控制权转交给某一个分区，
而是运行事先安装的启动管理器，由用户选择启动哪一个操作系统。比如，Linux 的 Grub，Windows 7 的 Bootmgr。

### 操作系统

控制权转交给操作系统后，操作系统的内核首先被载入内存。

以 Linux 系统为例，先载入 /boot 目录下面的 kernel。内核加载成功后，第一个运行的是 /sbin/init 程序。
init 进程是 Linux 启动后的第一个进程，pid 进程编号为 1，其他进程都是它的后代。
然后，init 进程加载操作系统的各个模块，进而启动整个 Linux 系统。

如果是 Windows 7 的话，先载入 windows\system32\winload.exe。
然后，winload.exe 去加载 Windows 7 内核和操作系统的各个模块，进而启动整个 Windows 7 系统。

## 参考

- {百度百科}/\[bios、扩展引导记录\]
- {CSDN}/{JerkWisdom}/[操作系统引导过程](https://blog.csdn.net/jonathan321/article/details/51987680)
- {阮一峰的网络日志}/[计算机是如何启动的？](http://www.ruanyifeng.com/blog/2013/02/booting.html)
