---
draft: false
date: 2023-07-29 08:00:00 +0800
title: "浮点数（笔记片段）"
summary: "x87 浮点数；移动数据；四则运算；浮点数比较；四舍五入；绝对值；取反；三角函数；"
toc: true

categories:
  - assembly-language(汇编语言)

tags:
  - computer-science(计算机科学)
  - programming-language(编程语言)
  - assembly-language(汇编语言)
---

## 前言

实践的环境：同 [x86-64_架构]()

## 资料

示意图：
- <a href="/drawio/computer-science/programming-language/assembly/assembly.drawio.html">assembly.drawio.html</a>

## 正文

### x87 浮点数

[基本架构手册第 8 章]() 这里主要看的是 x87 浮点数相关的内容。

[基本架构手册 8.1.2 节]() 这里主要看的是 x87 浮点数的寄存器栈相关的内容。

### 移动数据

#### fld、fild

把数据压入 fpu 栈。浮点数用 fld，整数用 fild。

每次入栈后，st(0) 都会指向新入栈的元素。

示意图：assembly.drawio.html 4-2

#### fldz、fld1、fldpi

入栈 0.0；入栈 1.0；入栈 pi；

#### fst、fstp、fist、fistp

把 st(0) 中的数据移动到目标操作数上去。

浮点数用 fld、fstp，整数用 fist、fistp。

fstp、fistp 附带弹栈操作。

#### fcomvcc

测试 eflags 的标志位，如果为真，则将源操作数移至目标操作数
源操作数始终是 st(i) 之一，目标操作数始终是 st(0)

### finit

将 fpu 的控制寄存器、状态寄存器、标记寄存器、指令指针寄存器、数据指针寄存器设置为默认状态。
fpu 控制寄存器设置为 037fh（四舍五入，屏蔽所有异常，64 位精度）。状态寄存器清零（未设置异常标志，top 设置为 0）
寄存器堆栈中的数据寄存器保持不变，但全部标记为空（11b）。指令指针寄存器和数据指针寄存器都被清空。

### 四则运算

#### fadd、faddp、fiadd

浮点数加法

- 无操作数形式：将 st(1) 加上 st(0)，结果放在 st(1)，然后弹栈。
- 单操作数形式：将 st(0) 加上源操作数，结果放在 st(0)。
- 双操作数形式：将 st(i) 加上 st(0)，结果放在 st(i)；或者将 st(0) 加上 st(i)，结果放在 st(0)。

浮点数用 fadd、faddp；整数用 fiadd。

faddp 附带弹栈操作；

#### fsub、fisub、fsubp

浮点数减法

- 无操作数形式：将 st(1) 减去 st(0)，结果放在 st(1)，然后弹栈。
- 单操作数形式：将 st(0) 减去源操作数，结果放在 st(0)。
- 双操作数形式：将 st(i) 减去 st(0)，结果放在 st(i)；或者将 st(0) 减去 st(i)，结果放在 st(0)。

浮点数用 fsub、fsubp；整数用 fisub。

fsubp 附带弹栈操作；

#### fimul、fimul、fmulp

浮点数乘法

- 无操作数形式：将 st(1) 乘上 st(0)，结果放在 st(1)，然后弹栈。
- 单操作数形式：将 st(1) 乘上源操作数，结果放在 st(0)。
- 双操作数形式：将 st(i) 乘上 st(0)，结果放在 st(i)；或者将 st(0) 乘上 st(i)，结果放在 st(0)。

浮点数用 fimul、fmulp；整数用 fimul。

fmulp 附带弹栈操作；

#### fdiv、fidiv、fdivp

浮点数除法

- 无操作数形式：将 st(1) 除以 st(0)，结果放在 st(1)，然后弹栈。
- 单操作数形式：将 st(1) 除以源操作数，结果放在 st(0)。
- 双操作数形式：将 st(i) 除以 st(0)，结果放在 st(i)；或者将 st(0) 除以 st(i)，结果放在 st(0)。

浮点数用 fdiv、fdivp；整数用 fidiv。

fdivp 附带弹栈操作；

### 浮点数比较

#### fcom、fcomp、fcomi、fcomip

比较两个操作数。

fcom、fcomp 指令有两种形式。

- 无操作数形式，将 st(0) 和 st(1) 进行比较。
- 单操作数形式，将源操作数和 st(0) 进行比较。

根据比较结果设置 fpu 中的 c0、c2、c3 标志位。一般和 fstsw、sahf 一起用。

fcomi、fcomip 进行比较之后，会根据比较结果设置 eflags 中的 zf、pf、cf 标志位

fcomp、fcomip 附带弹栈操作

#### fstsw、sahf

fstsw，将 fpu 中的标志位存储到目标操作数。目标操作数一般是 ax。

sahf，用 ah 的值（ax 的高 8 位）设置 eflags 中的 sf、zf、af、pf、cf 标志位。

### 其他操作

#### frndint

根据当前的舍入模式，将 st(0) 舍入为最接近的整数值，结果存入 st(0)。

#### fabs、fchs

fabs，对 st(0) 取绝对值。

fchs，把 st(0) 的符号反转。

#### fsqrt

计算 st(0) 的平方根，结果存入 st(0)。

#### fsin、fcos

fsin，计算 st(0) 的正弦近似值，结果存入 st(0)。

fcos，计算 st(0) 的余弦近似值，结果存入 st(0)。

源操作数的单位必须是弧度，范围是 \[-2^63, +2^63\]。
