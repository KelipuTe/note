---
draft: false
title: "熔断"
summary: "熔断；"
toc: true

categories:
  - 架构

tags:
  - 计算机
  - 架构

date: 2024-03-18 08:00:00 +0800
---

## 反向链接

[服务注册与发现](/计算机/架构/服务注册与发现)；
[负载均衡](/计算机/架构/负载均衡)；

## 正文

### 熔断

熔断，服务本身出现问题时，主动拒绝新请求，直到服务恢复。
熔断可以给服务恢复的机会，是保障服务可用性的重要手段之一。

比如，服务端接收的请求过多处理不过来了，继续接收请求只会过载崩溃。
这时把现有请求处理完才可能让 CPU 负载降下来，所以的能主动拒绝新请求。

熔断还可以用于保护重要的组件。比如，一个接口对缓存的依赖非常严重。
只要缓存（比如 redis）不可用，就触发熔断，保护下游的数据库（比如 mysql）。
触发熔断后，持续不断地 ping redis，如果 redis 恢复了，就退出熔断状态。

熔断这里面涉及两个问题：什么时候开始熔断，怎么从熔断状态恢复。

### 什么时候开始熔断

这问题分两步：怎么判断服务出现异常，立刻熔断还是先观察再熔断。

异常的判断依据（阈值）需要根据实际的业务来选择。比如，响应时间、系统负载等。

已响应时间为例。假设服务的响应时间的 99 线是 1s。
这时可以规定超过 1.2s 的是异常请求（留点容错给那 1% 的偶发情况）。

判断依据有了，下一步是选立刻熔断还是先观察再熔断。
立刻熔断非常容易被偶发情况误触，可能服务处理完这个请求压力就下去了。

先观察一段时间，如果持续有超过 1.2s 的请求，那就说明服务确实在承压。
这时启动熔断机制就比较合适了，防止服务一直处于承压状态，最终过载崩溃。

观察的一段时间究竟设置多长，这很大程度依赖个人经验。
过短，频繁熔断影响业务。过长，反应太慢服务崩溃。
如果想设置的准确一点，那就看看用压测把服务压崩溃要多久。

### 怎么从熔断状态恢复

主要有两个问题：怎么确定服务压力下来了；怎么退出熔断状态恢复服务。

确定服务压力可以系统负载等做粗略判断。熔断状态没有请求，99 线是用不了的。

退出熔断状态这个就有点麻烦了。如果服务是因为高并发触发熔断的，
那么直接退出熔断状态，就意味着全量接收请求，服务马上又会进入熔断状态。

完全由服务端控制效果是不好的，这里需要客户端来进行配合。
结合服务注册与发现的可用性和负载均衡的动态加权这两个方案。

服务端是用自己的逻辑。客户端设置退出熔断状态的条件是等待一段时间。
服务端触发熔断时，会返回一个代表熔断的错误。客户端收到错误后，把这个服务端移到待检测列表。
客户端等待一段时间后，尝试发送请求给熔断的客户端。
如果失败了，则触发第二个等待一段时间。如果成功了，就把服务端移到可用列表，并给一个小权重。
后面就是动态加权的逻辑了，客户端慢慢恢复分发给这个服务端的流量。

### 小的点

抖动就是服务频繁地在正常和熔断两个状态之间来回切换。

拒绝请求也是需要消耗资源的，服务熔断了不代表一定能恢复。
熔断拒绝的只是业务，请求能进来证明 TCP 握手已经成功了，这要消耗系统资源的。
