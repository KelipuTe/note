---
draft: false
title: "降级"
summary: "降级；"
toc: true

categories:
  - 架构

tags:
  - 计算机
  - 架构

date: 2024-03-18 08:00:00 +0800
---

## 反向链接

[熔断](/计算机/架构/熔断)；

## 正文

### 降级

降级，服务本身出现问题时，不在提供完整的服务，而是尽量提供服务。
降级的重点在于，把不重要的功能的资源腾出来，优先共给重要的功能。
这里的资源可以是机器（重新部署），也可以是公共组件（数据库）等。

比如，淘宝双十一大促时，关闭退款功能。
对于淘宝来说，这是降级。对于退款服务来说，这是熔断。

降级和熔断很像，熔断那里的问题降级这里也有。
什么时候开始降级，怎么从降级状态恢复，服务抖动。
降级还需要考虑，怎么尽量提供服务（提供什么样的有损服务）。

在一些场景下，既可以用熔断，也可以用降级。
理论上应该优先使用降级。然而有些服务无法降级（写服务）。
如果希望系统负载尽快降低，那么应该优先使用熔断。

### 怎么尽量提供服务

降级分两大类：本服务降级、跨服务降级。

本服务降级，本服务提供有损服务。这种策略的要点是得知道有损的程度。
比如，接口本来是分析用户的历史记录返回个性化内容的，降级后直接返回热点数据。

本服务降级的思路有：返回预设值、调整非核心组件、同步转异步。

非核心组件，可以是可观测性组件这种软件概念，也可以是非 vip 用户这种业务概念。
唯一的例外是跟合规相关的。比如，内容审核绝对不能降级，虽然它不赚钱，反而还亏钱。

跨服务降级，把低价值服务的资源腾出来，优先供给高价值服务。
这又分几种：停掉整个服务、停掉服务的部分节点、停止访问某些服务。

前面两个比较好理解，停止访问某些服务这个难一点，它不是针对服务自己的。
比如，下游的日志服务压力很大时，上游非核心服务就先不要访问了，让上游核心服务先访问。

#### 读写服务降级写服务

比如，商城系统同时有商家录入（写服务）和用户查询（读服务）功能。
这个场景里面，用户能不能查询到商品，关系到用户能不能下订单，更有价值的。

所以在服务压力过大时，可以关闭商家录入功能，把资源向用户查询倾斜。
而且数据库写请求的性能消耗要远大于读请求，降级之后也能减轻数据库负载。

比如，内容生产平台同时有作者生产内容和用户查看内容。

#### 快慢路径降级慢路径

如果服务可以分成快路径和慢路径两种逻辑。
那么在降级之前，可以先走快路径，再走慢路径。触发了降级之后，就只允许走快路径。

比如，在数据库前面加一个缓存减轻数据库压力的操作。
触发降级时，只从缓存读取，缓存没有就直接报错，不去请求数据库。

这样能够有效防止因为少部分请求缓存未命中而占据大量系统资源。
在缓存里面有数据的那部分请求可以正常处理，也算一种有损服务。

慢路径除了数据库，还可以是调用下游服务、调用第三方服务、执行复杂计算等。
