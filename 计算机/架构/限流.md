---
draft: false
title: "限流"
summary: "限流；"
toc: true

categories:
  - 架构

tags:
  - 计算机
  - 架构

date: 2024-03-25 08:00:00 +0800
---

## 反向链接

[降级](/计算机/架构/降级)；

## 正文

限流，通过限制流量来保护系统。典型的应用场景是：限制异常突发流量。

限流最主要的问题：限流阈值设置多大。
限流是一直开着的，没有什么时候开始限流和怎么从限流状态恢复这种问题。

限流算法分两大类：静态算法、动态算法（自适应限流算法）。和负载均衡有点像。

静态算法设定好之后，不管服务器实际负载。
算法：令牌桶、漏桶、固定窗口、滑动窗口、业务限流。

动态算法会监测系统的一系列指标动态调整限流阈值。
算法：BBR 算法（Bottleneck Bandwidth and Round-trip time）
动态算法的核心思路和 TCP 的拥塞控制算法非常相似。

### 静态算法

#### 令牌桶

系统以一个恒定的速率产生令牌。
令牌会放到一个桶里面，桶有一定的容量。
每个请求只有拿到了令牌才会被执行。

#### 漏桶

当请求以不均匀的速度到达服务器之后，限流器会以固定的速率转交给业务逻辑。
漏桶可以看作是令牌桶的一种特殊形态。把令牌桶的容量设置为 0，就是漏桶了。
令牌产生之后，立刻就需要被取走，如果没被取走，那么令牌也不会积攒下来。

#### 固定窗口

每个固定时间段内，只允许固定数量的请求。
比如，每 2 秒只能执行 10 个请求。

固定窗口有一个问题，瞬时最大流量会是固定数量的两倍。
比如，前一个 2 秒的第 1 秒都没有请求，第 2 秒 10 个请求。
后一个 2 秒的第 1 秒 10 个请求，第 2 秒都没有请求。
这时，在两个 2 秒内部的某个 2 秒就会有 20 个请求被放过去。

| -       | 1 | 2  | 3  | 4 |
|---------|---|----|----|---|
| 前一个 2 秒 | 0 | 10 | -  | - |
| 后一个 2 秒 | - | -  | 10 | 0 |

1-2 和 3-4 这两个 2 秒的窗口，请求都是 10。
但是内部的 2-3 这个 2 秒的窗口，请求就是 20。

#### 滑动窗口

滑动窗口本质上也是固定窗口，只不过使用方式不一样。
固定窗口是突然移动整个窗口，滑动窗口是平滑移动整个窗口。

比如，同样是每 10 秒只能执行 10 个请求。
固定窗口是，1-10 完了马上就 11-20，中间没有过度。
滑动窗口是，1-10，2-11，。。。，10-19，11-20，一点点挪过去的。

理论上步长越小限流越精确，但是越小的步长就意味着越多的移动次数。
记录请求数的数据结构需要考虑并发问题，不停地计算请求数也要消耗资源。

固定窗口和滑动窗口都有毛刺问题。
理想情况，请求会均匀分布在窗口里。但是不能排除请求会集中在一个瞬间。
这种情况是有可能压垮服务器的。所以窗口不能太长，以秒为单位比较合适。

### 动态算法

BBR 算法。

### 限流对象

单机限流、集群限流、业务限流。

业务限流是指结合具体的业务来设置限流对象。
比如，触发限流时，放行vip用户的请求，限流普通用户的请求。

### 被限流的请求怎么办

- 同步阻塞等待一段时间。注意这里要超时控制。
- 同步转异步（降级）。比如，先塞到消息队列里，稍后再处理。
- 返回限流标志给客户端，让客户端调整负载均衡并重试。

### 请求本身的问题

和负载均衡一样，大多数限流算法都没有考虑请求本身。

### 如何计算阈值

#### 观测

观测业务高峰的时候集群的情况。主要看QPS和关键组件的负载情况。
然后可以根据组件的负载比例，粗略的估算一下集群能负担的最大QPS。
这个估算肯定是有偏差的，因为实际场景中，QPS和负载不是线性关系。

#### 全链路压测

一定是全链路压测，系统瓶颈通常是数据库，但并不绝对。
只压测系统的一部分对计算整个系统的阈值其实没什么帮助。

通过压测可以得到 QPS、响应时间、组件负载之类的数据。
把这些数据做成图像，QPS 和响应时间，这两个指标会有明显的拐点。
图像拐点处的数值就是可以考虑作为整个系统限流阈值的数值。

全链路压测理论上是最准确的，但是通常情况下不容易操作。
测试环境不可能和线上用一样的配置，线上压力测试容易影响业务。

#### 借鉴相似项目的数据

相似功能之间可以借鉴。

相似系统之间可以借鉴。
