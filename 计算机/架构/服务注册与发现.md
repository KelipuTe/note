---
draft: false
title: "服务注册与发现"
summary: "服务注册与发现；"
toc: true

categories:
  - 架构

tags:
  - 计算机
  - 架构

date: 2024-03-18 08:00:00 +0800
---

## 反向链接

[分布式系统CAP问题](/计算机/架构/分布式系统CAP问题)；

## 正文

### 服务注册与发现

服务注册与发现一般用于分布式系统。

主要有注册中心、服务端、客户端这几个主体。客户端（上游）通过注册中心找到服务端（下游）。

分布式系统想要不停机平滑上线，服务注册与发现就是必须的，除非可以停机维护。

### 注册中心

主要功能：收集服务端的信息、把服务端的信息提供给客户端。

最核心的信息是服务端的定位信息。例如，服务名+ip+端口。
通过服务名获取服务端的信息，通过ip和端口调用服务端。

除了最核心的定位信息，还可以根据实际需要添加别的信息。
比如，是生产环境还是测试环境、是vip节点还是普通节点等。

常规选型：ZooKeeper、Etcd、Nacos。
邪教选型：MySQL、Redis。成本低，神似即可，服务端轮询写，客户端轮询读。

体量小就选 CP，比如，ZooKeeper。体量大就选 AP，比如，Nacos。

### 服务端

注册中心通过维持和服务端之间的心跳获取服务端的状态。

服务器上线步骤：等待系统完全启动；去注册中心登记上线。
服务器下线步骤：去注册中心登记下线；等待一段时间后关闭系统。

从去注册中心登记下线到所有的客户端都收到服务器下线的消息是需要时间的。
在这段时间中，客户端依然会将请求发给服务端，所以服务端需要等待一段时间。

### 客户端

注册中心通过维持和客户端之间的心跳发送服务端的信息。

客户端和注册中心建立连接并获取服务端的信息。
当需要下游的时候，挑一个服务端把请求发过去。

### 高可用

高可用就是保证注册中心-服务端、注册中心-客户端、服务端-客户端这三条线都可用。

客户端爆炸无关紧要，注册中心不容易爆炸，高可用的问题一般集中在服务端爆炸。

注册中心爆炸的问题是最大的，但是注册中心的功能比较简单，而且常用选型已经经过长时间的检验。
服务端爆炸分两个问题：注册中心怎么判断服务端爆炸了；客户端发现服务端爆炸了怎么办。

#### 注册中心怎么判断服务端爆炸了

这个主要靠注册中心和服务端之间的心跳。
心跳连不上分两种情况：服务端爆炸；网络问题。

服务端爆炸，注册中心直接通知客户端即可。网络问题比较麻烦，服务端可能活的挺好。
这种情况，注册中心可以一边通知客户端有下线，一边继续发心跳。如果连上了，再通知客户端有上线。

这里面还涉及到重试次数和重试间隔的问题。
重试次数太少准确性不够，重试次数太多浪费资源。
重试间隔太短大概率还会失败（网络问题可能好几秒才恢复），重试间隔太长及时性不够。

#### 客户端发现服务端爆炸了怎么办

从注册中心发现服务端爆炸了到所有的客户端都收到消息是需要时间的。
在这段时间中，客户端如果发现服务端爆炸了那就只能靠自己了。

常用的处理手段就是设计容错（failover）机制。比如，如果请求失败了，可以换一个节点重试。
之前那个节点就先放到待检测列表里去。如果注册中心通知下线了，那就直接删掉。
如果注册中心没通知下线，那么就是自己和服务端之间有问题，这种情况只能自己发心跳试。
如果试了几次都不成功，就放到不可用列表里去，直到注册中心通知最新的信息的时候再刷新。
