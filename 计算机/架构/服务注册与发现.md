---
draft: false
title: "服务注册与发现"
summary: "服务注册与发现；"
toc: true

categories:
  - 架构

tags:
  - 计算机
  - 架构

date: 2024-03-18 08:00:00 +0800
---

## 正文

### 服务注册与发现

服务注册与发现是分布式系统中的一个组成部分。
上游服务通过服务注册与发现找到下游服务，然后完成整个功能。

当机器数量比较少的时候，服务注册与发现还不是必须的。
上游系统可以在代码里直接指定下游系统的域名或者ip列表。

当机器数量达到一定规模后，服务注册与发现这玩意是一定要上的。
因为机器太多了，靠人工是管不过来的。虽然上线操作都是流程化的。
但是如果机器太多，一个是重复次数太多费劲，另一个是人工操作难免出错。

参与服务注册与发现的主要有三个主体：注册中心、服务端、客户端。

注册中心主要功能是：收集服务端的信息、把服务端的信息提供给客户端。

服务端上线时，先启动自己，然后去注册中心登记上线。
服务端下线时，先去注册中心登记下线，然后等待一段时间后关闭自己。
等待一段时间的目的在于，从去注册中心登记下线到所有的客户端都收到消息是需要一段时间的。这段时间中，依然可能会有客户端的请求过来。
服务端和注册中心之间需要保持心跳，注册中心可以及时知道服务端的状态。

客户端比较简单，去注册中心获取服务端的信息，然后把拿到的信息缓存下来。
当需要调用下游服务的时候，从拿到的信息里挑一个服务端然后把请求发过去。
客户端和注册中心之间需要保持心跳，这样注册中心可以及时把最新的服务端的信息同步给客户端。

### 注册中心

注册中心最核心的信息是服务端的定位信息。例如，服务名+ip+端口。
客户端能找得到服务端的信息，找到之后能调通服务端的接口。

除了核心的定位信息之外，还可以根据需要，自主添加别的信息。
比如，生产环境还是测试环境、vip结点还是普通结点、当前连接数有多少、等。

常规选型：ZooKeeper、Etcd、Nacos。
邪教选型：自主研发、MySQL、Redis。

CAP 对于选型的影响：体量小就用 CP，ZooKeeper。体量大就用 AP，Nacos。

### 高可用

在服务注册与发现模型中，注册中心、服务端、客户端两两之间都有联系。
高可用就是保证注册中心-服务端、注册中心-客户端、服务端-客户端这三条线。

这三个主体都有几率原地爆炸。客户端原地爆炸在这个模型里是无关紧要的。
注册中心原地爆炸问题是最大的，但是注册中心的功能一般比较简单，而且常用选型已经经过长时间的检验，原地爆炸的几率是非常小的，组个集群一般就问题不大了。
问题主要集中在服务端爆炸了怎么办。这里面又分成了两个问题，注册中心怎么判断服务端已经爆炸了，客户端发现服务端爆炸了怎么办。

#### 注册中心怎么判断服务端已经爆炸了

这个主要靠注册中心和服务端之间的心跳。
心跳连不上又分两种情况，服务端爆炸导致的连不上，各种意外情况导致的连不上。

真爆炸了倒也好办，不好办的是各种意外情况，服务端有可能一点事都没有。
这种情况注册中心可以一边通知客户端有服务端下线了，另一边继续给心跳连不上的服务端发心跳，看看是不是真死了。如果后面有能连上了，就再通知客户端有服务端上线了。

这里面还涉及到重试次数和重试间隔的问题。重试次数太少准确性不够，重试次数太多浪费系统和网络资源。重试间隔太短大概率还会失败（比如，偶发的网络抖动可能好几秒才恢复），重试间隔太长及时性不够。

#### 客户端发现服务端爆炸了怎么办

从注册中心发现服务端爆炸到所有的客户端都收到消息是需要一段时间的。
在这段时间中客户端如果发现服务端爆炸了那就只能靠自己了。

常用的处理手段就是设计容错（failover）机制。比如，如果请求失败了，可以从可用列表里换一个服务端结点重试。之前那个结点就先放到待检测列表里去。

如果注册中心来下线通知了，那正好丢弃掉。如果注册中心没来下线通知，那么就是自己和服务端之间的网络有问题，这种情况只能自己发心跳试。如果试了几次都不成功，就放到不可用列表里去。直到下一次注册中心发最新的服务端的信息的时候，再刷新这几个列表。
