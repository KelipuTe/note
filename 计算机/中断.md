---
draft: false
date: 2022-04-16 08:00:00 +0800
title: "中断"
summary: "中断是什么；硬件中断；CPU 怎么知道有中断的；软件中断；"
toc: true

categories:
  - 计算机

tags:
  - 计算机
  - 中断
---

## 反向链接

[CPU执行程序的过程](/计算机/硬件/CPU执行程序的过程)；

## 正文

### 中断是什么

中断（interrupt）是发送给 CPU 的信号。告诉 CPU 发生了需要注意的事件。

中断属于整个 CPU 设计的一部分，CPU 内部会有一整套的机制来检测和响应中断。
简单地说，CPU 内部要先有中断这样的设计，然后外部才能通过设计中给定的方式去使用。

整个中断机制分为硬件和软件两个部分。

硬件部分包括中断请求线路、中断控制器（interrupt controller）、中断向量表（IVT）或中断描述符表（IDT）。

- 中断请求线路：外部设备（硬件组件、外设）通过中断请求线路 CPU 连接。
- 中断控制器：通常用于管理中断并确定其优先级。
- 中断向量表、中断描述符表：CPU 维护着一个名为中断向量表或中断描述符表的数据结构。
  该数据结构可将每个中断映射到特定的中断处理例程。数据结构里面就是不同中断的条目，每个条目都指向相应的中断处理程序的地址。

软件部分包括中断处理程序和中断服务例程（ISR），它是为响应特定的中断而设计的特定的代码。

- 中断处理例程（interrupt handler routine）：响应特定的中断而设计的特定的代码。
- 中断服务例程（interrupt service routine、ISR）：针对某个中断的程序，负责处理与中断设备相关的事件或数据。
  在我看来和中断处理例程是一个玩意，不同的资料说法不一样。
- 中断处理程序（interrupt handler）：管理硬件设备的中断信号并调用适当的中断处理例程或中断服务例程。

中断有两种类型硬件中断（hardware interrupt）和软件中断（software interrupt）。

### 硬件中断的处理过程

硬件中断对于计算机系统的正常运行至关重要，因为它们允许硬件设备与 CPU 进行交互，而不会垄断 CPU 的资源。
产生中断的硬件设备的常见例子包括键盘、鼠标、网卡和硬盘。

硬件中断可以大概分为下面几部分：中断请求，中断响应，保护现场，中断处理，恢复现场，中断返回。

中断请求（IRQ）：外部设备在需要 CPU 注意时，就用中断请求线路给 CPU 发信号，这通常是一个硬件信号。

中断控制器接收来自各种外部设备的信号，并决定将哪个中断请求转发给 CPU。

中断向量：发生中断时，中断控制器会向 CPU 发送中断向量。中断向量是一个数值，用作中断向量表或中断描述符表的索引。

中断确认：CPU 通过向中断控制器发送确认信号来确认中断。该确认通知中断控制器 CPU 已收到中断请求。

保存状态：在将控制权转移到中断处理程序之前，CPU 会保存其当前状态。
包括寄存器和程序计数器的内容，以便 CPU 在处理完中断后能继续执行之前的任务。

执行中断服务例程：CPU 保存状态之后，会跳转到 IDT 中中断向量指定的内存地址，该内存地址包含中断服务例程的代码。

中断返回：中断服务例程执行完成后，CPU 会恢复已保存的状态，继续执行之前的任务。

比如，CPU 正在跑一个程序。这时，按一下键盘（产生中断请求）。
这个中断请求被发给 CPU 之后，CPU 会做出反应（中断响应）。

这时，CPU 会先停下正在跑的程序，把程序现在的状态记下来（保护现场）。
然后，过来处理这个中断请求（中断处理）。这个时候 CPU 里跑的是另外一个程序（中断处理例程）。

中断处理例程执行结束之后，需要把状态恢复到刚才停下的那个时候（恢复现场）。
这次中断就完事了，从中断处理例程中退出来（中断返回）。然后，就可以继续执行程序了。

### CPU 怎么知道有中断的

CPU 设计为定期检查中断，通常是在指令之间或执行指令的特定时间点进行检查。通常是这样工作的：

- 中断启用/禁用标志位：CPU 的标志位或控制位可确定中断当前是启用还是禁用。只有在启用中断时，CPU 才会响应中断请求。
- 中断检查点：在指令执行过程中的某些时刻，CPU 会检查中断线路的状态。通常发生在指令之间或指令周期结束时。
- 中断优先级：CPU 可能有一个处理中断的优先级方案。高优先级中断的检查频率可能高于低优先级中断。
- 中断确认：如果某个中断请求线路被断言（表明有中断信号），CPU 就会确认中断并开始中断处理的流程。

CPU 在执行过程中的特定时刻检查中断而不需要不断的检查中断。
一方面确保 CPU 可以及时响应外部事件，另一方面不会过度占用 CPU 处理常规任务的资源。
在及时响应中断与执行常规任务的效率之间取得了一个平衡。

### 软件中断

软件中断（software interrupt）也被称为陷阱（trap）或异常（exception），是一个由程序产生的信号。
它使 CPU 中断其当前任务并执行一个特定的例程（routine）来处理中断。
与由外部硬件设备产生的硬件中断不同，软件中断是由 CPU 上运行的程序产生的。

有两种主要的软件中断类型：同步（synchronous）和异步（asynchronous）。
同步中断是由 CPU 响应程序中的指令而产生的，比如，除以 0 或无效的内存访问。
异步中断是由外部事件产生的，比如，一个定时器或来自另一个进程的信号。

当一个软件中断产生时，CPU 会保存程序的当前状态，包括指令指针和寄存器值。
然后跳转到一个特定的例程，称为中断处理程序或异常处理程序。
中断处理程序负责处理中断，其中可能涉及错误处理、内存管理或 I/O 操作等任务。

中断处理完毕后，CPU 恢复程序的保存状态，并在被中断的地方恢复执行。
软件中断是程序与操作系统进行通信和执行需要特权访问的任务的重要机制，比如，系统调用或中断另一个进程。
