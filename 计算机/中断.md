---
draft: false
date: 2022-04-16 08:00:00 +0800
title: "中断"
summary: "硬件中断；软件中断；中断处理例程；中断处理程序；"
toc: true

categories:
  - 操作系统

tags:
  - 计算机
  - 操作系统
  - 中断
---

## 前言

## 资料

- [{demo-c}](https://github.com/KelipuTe/demo-c)/demo-in-linux/signal/

## 正文

### 中断

在计算机系统中，中断是发送给中央处理器的信号，提醒它发生了需要注意的事件。中央处理器需要一种机制来检测和响应中断。以下是 CPU 如何知道发生了中断的简化解释：


    中断请求 (IRQ) 线路： 与 CPU 连接的硬件设备都有中断请求线。当外设或硬件组件等外部设备需要关注时，就会断言其相应的 IRQ 线路。


    中断控制器：在现代计算机体系结构中，中断控制器通常用于管理中断并确定其优先级。中断控制器接收来自各种设备的信号，并决定将哪个中断请求转发给 CPU。


    中断描述符表（IDT）： CPU 维护一个名为 "中断描述符表"（IDT）的数据结构。IDT 是一个中断向量表，可将每个中断映射到特定的处理程序例程。CPU 启动时会初始化 IDT。


    中断向量： 发生中断时，中断控制器会向 CPU 发送中断向量。中断向量是一个数值，用作 IDT 的索引。该向量指向特定中断的中断处理程序位置。


    中断确认： CPU 通过向中断控制器发送确认信号来确认中断。该确认通知中断控制器 CPU 已收到中断请求。


    保存状态： 在将控制权转移到中断处理程序之前，CPU 会保存其当前状态。这包括保存寄存器和程序计数器的内容，以便 CPU 在处理完中断后能继续执行之前的任务。


    执行中断处理程序： 然后，CPU 跳转到 IDT 中为相应中断向量指定的内存地址。该内存地址包含中断处理程序的代码。


    中断处理程序例程： 中断处理程序是一段代码，负责处理触发中断的特定事件。它执行必要的操作，如处理来自设备的数据或处理系统事件。


    从中断返回： 中断处理程序完成任务后，会恢复已保存的 CPU 状态，并将控制权返回给被中断的程序，使其从中断的位置继续运行。


总之，CPU 在中断请求线路上接收到中断信号时，就知道发生了中断，然后通过调用相应的中断处理程序，按照一系列步骤处理中断。


中央处理器不会以轮询方式在每个时钟周期检查中断，而是依靠一种称为中断驱动处理的机制。下面是更详细的解释：

    中断线路： 外部设备（如外设或硬件组件）通过中断线与 CPU 连接。这些线路是外部设备在需要 CPU 注意时发出的信号。

    中断控制器：在许多计算机系统中，都有一个中断控制器（如可编程中断控制器或 PIC），负责管理和优先处理来自各种设备的中断。中断控制器接收来自这些设备的信号，并决定向 CPU 提交哪个中断。

    中断请求（IRQ）： 当设备有需要注意的数据或事件时，会发出相应的中断请求线。这通常是一个硬件信号，表示 CPU 需要中断当前任务，关注请求设备。

    中断向量表（IVT）： CPU 维护着一个名为 "中断向量表（IVT）"或 "中断描述符表（IDT）"的数据结构，具体取决于体系结构。该表包含不同中断类型的条目，每个条目都指向相应中断处理程序的地址。

    中断调度： 中断请求发出后，中断控制器会确定中断的优先级，并向 CPU 发送中断信号。该信号包括中断编号或向量。

    中断处理： 收到中断信号后，CPU 会中断当前任务，保存当前状态（包括程序计数器和寄存器内容），并跳转到 IVT 中中断向量指定的内存位置。

    中断服务例程（ISR）： 中断向量指向的内存位置包含中断服务例程（ISR）或中断处理程序的代码。该例程专门针对中断类型，负责处理与中断设备相关的事件或数据。

    确认： 一旦 CPU 准备好处理中断，就会向中断控制器发送确认信号，通知它已收到中断并正在处理。

    从中断返回： ISR 执行完毕后，CPU 会恢复其保存的状态，以便继续执行被中断的任务。

总之，CPU 在其中断线路上接收到硬件信号时，就知道发生了中断，然后通过中断向量、中断控制器和中断服务例程的组合来处理中断。这一过程是事件驱动的，当外部设备需要注意时就会触发中断。



处理中断的过程涉及硬件和软件两个部分。硬件组件包括中断线路、中断控制器和 CPU 内部的中断向量表（IVT）或中断描述符表（IDT）。软件组件是中断服务例程（ISR）或中断处理程序，它是为响应特定类型中断而设计的一段特定代码。

外部设备（如外设或硬件组件）可以使用中断机制与 CPU 通信。当设备有数据要传输、有事件要报告或因其他原因需要关注时，它可以断言其相应的中断线路。这将触发 CPU 中的中断机制，从而执行相应的 ISR。

使用中断可以高效处理事件，CPU 无需持续轮询或检查设备状态。相反，CPU 可以专注于当前任务，直到中断发生，然后迅速切换到必要的中断处理程序来处理特定事件。

总之，中断机制是外部设备与 CPU 之间的一种通信方式，为设备及时有效地请求关注或报告事件提供了途径。该机制的设计和实施涉及硬件和软件两个部分。

### 硬件中断

硬件中断（hardware interrupt）是一个由硬件设备产生的信号，它需要 CPU 关注。
硬件中断用于允许硬件设备与 CPU 进行通信，而不需要一直轮询或者等待 CPU 关注。

当一个硬件设备产生一个中断时，它向中断控制器发送一个信号。
然后，中断控制器（interrupt controller）向 CPU 发送一个信号，中断其当前任务并处理该设备的请求。
然后，CPU 将停止执行其当前任务并处理中断，这包括暂时保存 CPU 的状态和执行中断处理例程（interrupt handler routine）。

中断处理例程是一段由 CPU 响应中断而执行的代码。
它负责确定是哪个设备产生了中断，处理来自该设备的请求，并恢复 CPU 的状态，以便它能够恢复其先前的任务。

硬件中断对于计算机系统的正常运行至关重要，因为它们允许硬件设备与 CPU 进行交互，而不会垄断 CPU 的资源。
产生中断的硬件设备的常见例子包括键盘、鼠标、网卡和硬盘。

硬件中断可以大概分为下面几部分：中断请求，中断响应，保护现场，中断处理，恢复现场，中断返回。

比如，CPU 正在跑一个程序。这时，按一下键盘（产生中断请求）。这个中断请求被发给 CPU 之后，CPU 会做出反应（中断响应）。

这时，CPU 会先停下正在跑的程序，把程序现在的状态记下来（保护现场）。
然后，过来处理这个中断请求（中断处理）。这个时候 CPU 里跑的是另外一个程序（中断处理例程）。

中断处理例程执行结束之后，需要把状态恢复到刚才停下的那个时候（恢复现场）。
这次中断就完事了，从中断处理例程中退出来（中断返回）。然后，就可以继续执行程序了。

### 软件中断

软件中断（software interrupt）也被称为陷阱（trap）或异常（exception），是一个由程序产生的信号。
它使 CPU 中断其当前任务并执行一个特定的例程（routine）来处理中断。
与由外部硬件设备产生的硬件中断不同，软件中断是由 CPU 上运行的程序产生的。

有两种主要的软件中断类型：同步（synchronous）和异步（asynchronous）。
同步中断是由 CPU 响应程序中的指令而产生的，比如，除以 0 或无效的内存访问。
异步中断是由外部事件产生的，比如，一个定时器或来自另一个进程的信号。

当一个软件中断产生时，CPU 会保存程序的当前状态，包括指令指针和寄存器值，并跳转到一个特定的例程，称为中断处理程序或异常处理程序。
中断处理程序负责处理中断，其中可能涉及错误处理、内存管理或 I/O 操作等任务。

中断处理完毕后，CPU 恢复程序的保存状态，并在被中断的地方恢复执行。
软件中断是程序与操作系统进行通信和执行需要特权访问的任务的重要机制，比如，系统调用或中断另一个进程。

### 中断处理例程和中断处理程序的区别

中断处理例程（interrupt handler routine）和中断处理程序（interrupt handler）的关键区别在于，
中断处理例程是响应硬件设备的中断信号而执行的代码，而中断处理程序是管理中断信号并调用适当的中断处理例程的代码。
